<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School ·àã·ã≠·â•·à®·à™ Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* ·ã®·àµ·â≥·ã≠·àç ·äÆ·ãµ ·à≥·ã≠·âÄ·ã®·à≠ ·ã≠·âÄ·à´·àç */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            padding-bottom: 70px; 
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #333);
            /* ·àà·å®·àà·àõ ·åà·åΩ·â≥ ·àõ·àµ·â∞·ä´·ä®·ã´ */
            --tg-theme-bg-color: #1a1a1a;
            --tg-theme-secondary-bg-color: #2c2c2c;
            --tg-theme-text-color: #ffffff;
            --tg-theme-link-color: #00bfff; /* ·à∞·àõ·ã´·ãä */
            --tg-theme-hint-color: #aaaaaa;
        }
        h1, h2, h3 {
            color: var(--tg-theme-link-color, #007bff);
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .hidden-page {
            display: none !important;
        }
        
        /* ·ä†·ã≤·àµ ·àµ·â≥·ã≠·àç: ·â†·âÖ·ã∞·àù ·â∞·ä®·â∞·àç ·ã®·àö·ä®·çà·â± ·ä≠·çç·àé·âΩ·äï ·àà·àò·ã∞·â†·âÖ */
        .hidden-section {
            display: none !important;
        }
        
        /* ********** ·ã®·åã·à´ ·àµ·â≥·ã≠·àé·âΩ ********** */
        .info-card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            margin: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-bg-color, #eee);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .green-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        /* ********** ·àà·àù·àµ·àâ ·ä†·ã≤·àµ ·àµ·â≥·ã≠·àé·âΩ ********** */
        #tasks-main-container {
            padding: 0 10px; 
        }
        .timer-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .timer-segment {
            background-color: #333;
            color: #FFC107;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 2em;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        .tasks-top-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin: 20px 0;
        }
        .task-top-btn {
            background-color: #444;
            color: white;
            border: none;
            padding: 15px 5px;
            border-radius: 8px;
            font-weight: bold;
            flex: 1;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        .task-top-btn.daily::before {
            content: 'Daily';
            position: absolute;
            top: -5px;
            right: 0;
            background-color: #ff0000;
            color: white;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 5px;
        }
        .task-top-btn i {
            display: block;
            font-size: 2em;
            margin-bottom: 5px;
        }
        .task-row-card {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background-color: var(--tg-theme-secondary-bg-color, #2c2c2c);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .task-icon-large {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            margin-right: 15px;
        }
        .task-icon-road { background-color: #E91E63; } /* Pink-Red */
        .task-icon-100x { background-color: #9C27B0; } /* Purple */
        .task-icon-gift { background-color: #FFC107; } /* Yellow/Orange */
        .task-text-content {
            flex-grow: 1;
        }
        .task-title-large {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0 0 5px 0;
            color: var(--tg-theme-text-color, #ffffff);
        }
        .task-description {
            font-size: 0.85em;
            color: var(--tg-theme-hint-color, #aaa);
            margin: 0;
        }
        .task-action-button {
            background-color: #FFC107;
            color: #1a1a1a;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        /* ... (·àå·àé·âΩ ·àµ·â≥·ã≠·àé·âΩ ·à≥·ã≠·âÄ·ã®·à© ·ã≠·âÄ·à´·àâ) ... */
    </style>
</head>
<body>

    <div id="tasks-page" class="hidden-page" style="margin: -10px; padding: 0;">
        <div id="tasks-main-container">
            <h2 style="text-align: center; color: var(--tg-theme-text-color); margin-top: 15px; font-size: 1.2em;">
                ·ãï·àà·â≥·ãä ·â∞·åç·â£·à´·âµ ·åä·ãú·ãç
            </h2>
            
            <div class="timer-display">
                <div class="timer-segment" id="timer-hours">00</div>
                <span>:</span>
                <div class="timer-segment" id="timer-minutes">00</div>
                <span>:</span>
                <div class="timer-segment" id="timer-seconds">00</div>
            </div>
            
            <div class="tasks-top-buttons">
                <button class="task-top-btn daily" onclick="tg.showAlert('·â†·âÖ·à≠·â• ·âÄ·äï ·ã≠·å†·â•·âÅ...');" style="background-color: #FFC107;">
                    <i class="fas fa-trophy"></i>
                    Contest
                </button>
                <button class="task-top-btn" onclick="showTaskSection('spin-section');" style="background-color: #28a745;">
                    <i class="fas fa-redo"></i>
                    Spin
                </button>
                <button class="task-top-btn" onclick="tg.showAlert('·â†·âÖ·à≠·â• ·âÄ·äï ·ã≠·å†·â•·âÅ...');" style="background-color: #9C27B0;">
                    <i class="fas fa-gift"></i>
                    Coupon
                </button>
            </div>
            
            <div id="earning-section" class="task-row-card" onclick="showDetailTask('social-tasks-details');">
                <div class="task-icon-large task-icon-road">
                    <i class="fab fa-telegram-plane"></i>
                </div>
                <div class="task-text-content">
                    <p class="task-title-large">ROAD üì° ·ã®·â¥·àå·åç·à´·àù ·äÆ·àö·äí·â≤</p>
                    <p class="task-description">·ã®·â¥·àå·åç·à´·àù ·âª·äì·àç ·ä•·äì ·åç·à©·çï ·â†·àò·âÄ·àã·âÄ·àç ·äê·å•·â• ·ã´·åç·äô·ç¢</p>
                </div>
                <button class="task-action-button" style="background-color: #E91E63;">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div id="quiz-section-main" class="task-row-card" onclick="showDetailTask('quiz-details');">
                <div class="task-icon-large task-icon-100x">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="task-text-content">
                    <p class="task-title-large">100X üí° ·ã®·å≠·äï·âÖ·àã·âµ ·å•·ã´·âÑ·ãé·âΩ</p>
                    <p class="task-description">·â†·ä†·àà·àù ·ä†·âÄ·çç ·å•·ã´·âÑ·ãé·âΩ ·ãï·ãç·âÄ·âµ·ãé·äï ·ã≠·çà·âµ·àπ (5/24 ·à∞·ãì·âµ)</p>
                </div>
                <button class="task-action-button" style="background-color: #9C27B0;">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div id="daily-bonus-main" class="task-row-card" onclick="handleDailyClaim();">
                <div class="task-icon-large task-icon-gift">
                    <i class="fas fa-gift"></i>
                </div>
                <div class="task-text-content">
                    <p class="task-title-large">üéÅ ·ãï·àà·â≥·ãä ·àΩ·àç·àõ·âµ</p>
                    <p class="task-description" id="daily-claim-status">·ã®·ä•·àà·â± ·äê·çÉ ·åâ·à≠·àª! (+500 ·äê·å•·â•)</p>
                </div>
                <button class="task-action-button" 
                        id="daily-claim-button" 
                        data-claimed="false" 
                        style="background-color: #4CAF50;">
                    ·ãç·à∞·ãµ!
                </button>
            </div>
            
            <div id="spin-section" class="info-card hidden-section" style="text-align: center; padding: 20px;">
                <h3 style="color: #FFC107;">üéÅ ·ã®·ãõ·à¨ ·ãï·ãµ·àç·ãé! (Spin & Win)</h3>
                <p>·â†24 ·à∞·ãì·âµ ·ãç·àµ·å• **5** ·àô·ä®·à´·ãé·âΩ ·â•·âª</p>
                <div style="position: relative; width: 300px; height: 300px; margin: 20px auto;">
                    <canvas id="wheelCanvas" width="300" height="300"></canvas>
                    <div id="pointer"></div>
                </div>
                <button id="spin-button" class="green-button" style="padding: 15px 30px; font-size: 1.2em; width: 80%;">
                    ·ä•·àΩ·ä≠·à≠·ä≠·à©!
                </button>
                <p style="margin-top: 15px;">·âÄ·à™ ·àô·ä®·à´·ãé·âΩ: <span id="attempts-left">5</span></p>
                <p id="spin-timer-display" style="color: #dc3545; font-weight: bold; margin-top: 10px; display: none;">
                    ·ãµ·åã·àö ·àà·àò·å´·ãà·âµ: <span id="spin-countdown">...</span>
                </p>
                <button class="green-button" onclick="showTaskSection('main-tasks');" style="margin-top: 15px; background-color: #6c757d;">
                    ·ãà·ã∞ ·äã·àã
                </button>
            </div>
            
            <div id="social-tasks-details" class="info-card hidden-section" style="margin-top: 25px;">
                <h3 style="color: #E91E63; border-bottom: 1px solid #444; padding-bottom: 5px;">üî• ·ã®·àõ·àÖ·â†·à´·ãä Tasks</h3>
                
                <div class="info-item" id="task-tg-ch">
                    <span class="item-label">
                        <i class="fab fa-telegram-plane" style="color: #0088cc; margin-right: 5px;"></i> 
                        **·â¥·àå·åç·à´·àù ·âª·äì·àç ·â∞·âÄ·àã·âÄ·àç**
                    </span>
                    <span class="item-value">+150 ·äê·å•·â•</span>
                    <button class="green-button task-button" 
                            data-task-id="TG_CH" 
                            data-points="150"
                            data-url="https://t.me/ethio_schoollibrary"
                            data-task-text="·â∞·âÄ·àã·âÄ·àç!"
                            onclick="handleTaskClick('TG_CH', 'https://t.me/ethio_schoollibrary');">
                        ·â∞·âÄ·àã·âÄ·àç!
                    </button>
                </div>

                <div class="info-item" id="task-tg-gp">
                    <span class="item-label">
                        <i class="fab fa-telegram-plane" style="color: #00a4e4; margin-right: 5px;"></i> 
                        **·â¥·àå·åç·à´·àù ·åç·à©·çï ·â∞·âÄ·àã·âÄ·àç**
                    </span>
                    <span class="item-value">+100 ·äê·å•·â•</span>
                    <button class="green-button task-button" 
                            data-task-id="TG_GP" 
                            data-points="100"
                            data-url="https://t.me/school_library2012"
                            data-task-text="·â∞·âÄ·àã·âÄ·àç!"
                            onclick="handleTaskClick('TG_GP', 'https://t.me/school_library2012');">
                        ·â∞·âÄ·àã·âÄ·àç!
                    </button>
                </div>

                <div class="info-item" id="task-yt-sub" style="border-bottom: none;">
                    <span class="item-label">
                        <i class="fab fa-youtube" style="color: #ff0000; margin-right: 5px;"></i> 
                        **·ã©·â≤·ã©·â• ·à∞·â•·àµ·ä≠·à´·ã≠·â•**
                    </span>
                    <span class="item-value">+300 ·äê·å•·â•</span>
                    <button class="green-button task-button" 
                            data-task-id="YT_SUB" 
                            data-points="300"
                            data-url="YOUR_YOUTUBE_CHANNEL_LINK_HERE"
                            data-task-text="·à∞·â•·àµ·ä≠·à´·ã≠·â•"
                            onclick="handleTaskClick('YT_SUB', 'YOUR_YOUTUBE_CHANNEL_LINK_HERE');">
                        ·à∞·â•·àµ·ä≠·à´·ã≠·â•
                    </button>
                </div>
                 <button class="green-button" onclick="showTaskSection('main-tasks');" style="margin-top: 15px; background-color: #6c757d; width: 100%;">
                    ·ãà·ã∞ ·äã·àã
                </button>
            </div> 
            
            <div id="quiz-details" class="info-card hidden-section" style="text-align: center; padding: 20px;">
                <h3 style="color: #9C27B0;">üí° ·ã®·å≠·äï·âÖ·àã·âµ ·å•·ã´·âÑ·ãé·âΩ</h3>
                <p>·â†24 ·à∞·ãì·âµ ·ãç·àµ·å• **5** ·å•·ã´·âÑ·ãé·âΩ ·â•·âª</p>
                
                <div class="info-card" style="margin: 10px 0; background-color: #444;">
                    <p style="font-weight: bold; margin-bottom: 5px;">·âÄ·à™ ·àô·ä®·à´·ãé·âΩ: <span id="quiz-attempts-left">5</span></p>
                     <p id="quiz-timer-display" style="color: #dc3545; font-weight: bold; margin-top: 10px; display: none;">
                        ·ãµ·åã·àö ·àà·àò·å´·ãà·âµ: <span id="quiz-countdown">...</span>
                    </p>
                </div>
                
                <button class="green-button" onclick="alert('·â†·âÖ·à≠·â• ·âÄ·äï ·ã≠·å†·â•·âÅ ...');" style="width: 100%; padding: 12px; font-size: 1.1em; background-color: #9C27B0;">
                    ·ãï·ãç·âÄ·âµ·ãé·äï ·ã≠·àû·ä≠·à© (+50 ·äê·å•·â•)
                </button>
                
                <button class="green-button" onclick="showTaskSection('main-tasks');" style="margin-top: 15px; background-color: #6c757d; width: 100%;">
                    ·ãà·ã∞ ·äã·àã
                </button>
            </div>
            </div>
    </div>
    
    <div id="bottom-nav">
        <div class="nav-item active" onclick="switchPage('tasks');">
            <div class="nav-icon"><i class="fas fa-bolt"></i></div>
            Tasks
        </div>
        <div id="shop-nav" class="nav-item" onclick="switchPage('shop');">
            <div class="nav-icon"><i class="fas fa-shopping-bag"></i></div>
            Shop
        </div>
        <div class="nav-item" onclick="switchPage('top');">
            <div class="nav-icon"><i class="fas fa-crown"></i></div>
            Top
        </div>
        <div id="profile-nav" class="nav-item" onclick="switchPage('profile');">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            Profile
        </div>
    </div>
    

    <script>
        // 1. ·ã®·â¥·àå·åç·à´·àù ·ãå·â• ·ä†·çï ·ãã·äì ·äê·åà·à≠
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        // üí° ·ä†·ã≤·àµ ·ã®·â∞·å®·àò·à®: ·ã® Backend Function ·ä†·ãµ·à´·àª·ãé
        const NETLIFY_FUNCTION_URL = 'https://schoollibrary1.netlify.app/.netlify/functions/tbot_handler';
        
        // 2. ·ã®·ä´·â≥·àé·åç ·àò·à®·åÉ ·àò·ãã·âÖ·à≠ (Data)
        const bookData = [
            // ... bookData ·à≥·ã≠·âÄ·ã®·à≠ ·ã≠·âÄ·à´·àç ...
            {
                category: "·à≥·ã≠·äï·àµ",
                items: [
                    { id: "S001", name: "·ã®·à•·äê-·àï·ã≠·ãà·âµ ·àò·à†·à®·â∂·âΩ", price: 150.00, pdf_id: "PDF_SC01", photo_url: "https://via.placeholder.com/80x100?text=S001" },
                    { id: "S002", name: "·ã®·çä·ãö·ä≠·àµ ·âµ·àù·àÖ·à≠·âµ", price: 175.50, pdf_id: "PDF_SC02", photo_url: "https://via.placeholder.com/80x100?text=S002" },
                ]
            },
            {
                category: "·à•·äê ·åΩ·àë·çç",
                items: [
                    { id: "L001", name: "·ã®·àÄ·åà·à≠ ·çç·âÖ·à≠ ·åç·å•·àû·âΩ", price: 120.00, pdf_id: "PDF_LIT1", photo_url: "https://via.placeholder.com/80x100?text=L001" },
                    { id: "L002", name: "·ä†·å´·å≠·à≠ ·â≥·à™·äÆ·âΩ", price: 110.00, pdf_id: "PDF_LIT2", photo_url: "https://via.placeholder.com/80x100?text=L002" },
                ]
            },
            // ... ·ã®·â∞·âÄ·à®·ãç bookData
        ];

        let cart = [];
        let totalPrice = 0;
        
        // ********** ·ä® Backend ·ã®·àö·àò·å° ·â∞·àà·ãã·ãã·åÆ·âΩ (·â†·â¶·â± ·ã≥·â≥·â§·ãù ·àã·ã≠ ·ã®·â∞·âÄ·àò·å°) **********
        let currentPoints = 0; 
        let spinAttempts = 0; 
        let spinMaxAttempts = 5; 
        let spinResetTime = 0;
        let quizAttempts = 0; 
        let quizMaxAttempts = 5; 
        let quizResetTime = 0;
        let socialTasksStatus = {}; 
        let dailyClaimTime = 0;
        const DAILY_RESET_MS = 24 * 60 * 60 * 1000;
        let timerInterval = null;
        let mainTimerInterval = null;
        
        // ************************************************************************


        // ********** ·ã®·àò·äê·àª ·ã≥·â≥ ·àò·å´·äï (Backend·äï ·â†·âÄ·å•·â≥ ·ã®·àö·å†·à´) **********
        function loadInitialData() {
            // Frontend ·àò·åÄ·àò·à©·äï ·àà Backend ·àõ·à≥·ãà·âÖ ·ä•·äì ·ã≥·â≥·ãç·äï ·àò·å†·ã®·âÖ
            const initialDataRequest = {
                action: "request_initial_data",
                // ·ã©·ãò·à≠ ID ·ä®Frontend ·ãà·ã∞ Backend ·àò·àã·ä≠ ·ä†·àà·â†·âµ
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN"
            };

            // üí° ·ãà·à≥·äù ·àà·ãç·å•: ·â†·âÄ·å•·â≥ ·ãà·ã∞ Netlify Function URL ·àò·àã·ä≠
            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(initialDataRequest)
            })
            .then(response => {
                // ·àÅ·äî·â≥·ãç·äï ·âº·ä≠ ·ä†·ãµ·à≠·åç
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ·àò·àç·à±·äï ·ä•·äï·ã∞·â∞·âÄ·â†·àà ·â†·âÄ·å•·â≥ processBotResponse·äï ·àò·å•·à´·âµ
                processBotResponse(data);
            })
            .catch(error => {
                console.error('Frontend Fetch Error:', error);
                // "Backend data ·â†·àò·å†·â†·âÖ ·àã·ã≠ ·äê·ãç" ·ã®·àö·àà·ãç·äï ·àò·àç·ä•·ä≠·âµ ·àà·àò·â∞·ä´·âµ alert ·ä†·à≥·ã≠
                // tg.showAlert(`‚ùå ·ä® Backend ·ã≥·â≥ ·à≤·å†·ã®·âÖ ·âΩ·åç·à≠ ·â∞·çà·å†·à®! ${error.message} (Log ·ã≠·àò·àç·ä®·â±)`);
            });
            
            // ·ã®·çï·àå·ã≠·àµ·àÜ·àç·ã∞·à≠ ·ã≥·â≥ (·àà·àõ·à≥·ã´·äê·âµ)
            updatePointsDisplay(0);
            updateSpinDisplay(); 
        }
        
        // ********** ·ã®·åã·à´ ·ä•·äì ·ã®·çï·àÆ·çã·ã≠·àç ·â∞·åç·â£·à´·âµ **********
        function initializeProfile() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                const username = user.username || (user.first_name + " " + (user.last_name || "")).trim();
                document.getElementById('display-username').textContent = username;
                document.getElementById('profile-initial').textContent = username.charAt(0).toUpperCase();
            }
            // ·äê·å•·â°·äï ·ä® currentPoints ·àõ·à≥·ã®·âµ
            updatePointsDisplay(currentPoints);
        }

        // ********** ·ã®·åà·åΩ ·àò·âÄ·ã®·à™·ã´ ·â∞·åç·â£·à≠ (Switch Page Logic) **********
        function switchPage(pageName) {
            // ... (·ã®·åà·åΩ ·àò·âÄ·ã®·à™·ã´ ·äÆ·ãµ ·à≥·ã≠·âÄ·ã®·à≠ ·ã≠·âÄ·à´·àç)
            const pages = ['shop-page', 'profile-page', 'tasks-page', 'top-page'];
            const navItems = document.querySelectorAll('#bottom-nav .nav-item');
            
            // ·àÅ·àâ·äï·àù ·åà·åæ·âΩ ·ã∞·â•·âÖ
            pages.forEach(id => {
                const pageElement = document.getElementById(id);
                if (pageElement) {
                    pageElement.classList.add('hidden-page');
                }
            });
            
            // ·ã®·â∞·àò·à®·å†·ãç·äï ·åà·åΩ ·ä†·à≥·ã≠
            const selectedPageId = `${pageName}-page`;
            const selectedPageElement = document.getElementById(selectedPageId);
            if (selectedPageElement) {
                selectedPageElement.classList.remove('hidden-page');
            }

            // ·ã®·ã≥·à∞·à≥ ·ä†·ãù·à´·àÆ·âΩ·äï ·àÅ·äî·â≥ ·ä†·àµ·â∞·ä´·ä≠·àç
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.onclick.toString().includes(`'${pageName}'`)) {
                    item.classList.add('active');
                }
            });

            if (pageName === 'shop') {
                updateCartDisplay();
            } else {
                tg.MainButton.hide();
            }
            
            // üí° ·â∞·àµ·â∞·ä´·ä≠·àè·àç: Tasks ·åà·åΩ ·à≤·ä®·çà·âµ ·ãã·äì·ãç Tasks ·åà·åΩ ·ä•·äï·ã≤·â≥·ã≠ ·ã´·ã∞·à≠·åã·àç
            if (pageName === 'tasks') {
                showTaskSection('main-tasks');
                startMainCountdown();
            } else {
                clearInterval(mainTimerInterval);
            }
            
             if (pageName === 'profile') {
                initializeProfile(); 
            }
        }
        
        // ********** ·ã®·ãã·äì Tasks ·åà·åΩ ·à∞·ãì·âµ ·âÜ·å£·à™ **********
        function startMainCountdown() {
             clearInterval(mainTimerInterval); 
             
             // ·àà Spin ·ãà·ã≠·àù Quiz ·ã≥·åç·àù ·àõ·àµ·åÄ·àò·à≠ ·ã®·àö·âÄ·à®·ãç·äï ·ä®·çç·â∞·äõ ·åä·ãú ·ã≠·å†·âÄ·àõ·àç
             let latestResetTime = Math.max(spinResetTime, quizResetTime, dailyClaimTime);
             
             if (latestResetTime === 0) {
                 // ·ã≥·â≥·ãç ·ä´·àç·àò·å£ ·à∞·ãì·âµ ·âÜ·å£·à™·ãç·äï ·ä†·ã´·à≥·ã≠·àù
                 document.getElementById('timer-hours').textContent = '00';
                 document.getElementById('timer-minutes').textContent = '00';
                 document.getElementById('timer-seconds').textContent = '00';
                 return;
             }

             function updateMainTimer() {
                const now = Date.now();
                const elapsed = now - latestResetTime; 
                const remaining = DAILY_RESET_MS - elapsed;

                if (remaining <= 0) {
                    clearInterval(mainTimerInterval);
                    
                    // ·ã≥·åç·àù ·àõ·àµ·åÄ·àò·à≠ ·ã®·àö·ã´·àµ·çà·àç·åà·ãç ·ä®·àÜ·äê ·ã≥·â≥·ãç·äï ·ä® Backend ·ã≠·å†·ã≠·âÉ·àç
                    if (spinAttempts < spinMaxAttempts || quizAttempts < quizMaxAttempts || (now - dailyClaimTime) >= DAILY_RESET_MS) {
                        fetch(NETLIFY_FUNCTION_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                action: "request_full_reset", 
                                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN" 
                            })
                        }).then(r => r.json()).then(processBotResponse).catch(e => console.error("Full Reset Error:", e));
                    }
                    
                    document.getElementById('timer-hours').textContent = '00';
                    document.getElementById('timer-minutes').textContent = '00';
                    document.getElementById('timer-seconds').textContent = '00';
                    return;
                }

                const totalSeconds = Math.floor(remaining / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                document.getElementById('timer-hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('timer-minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('timer-seconds').textContent = String(seconds).padStart(2, '0');
            }

            mainTimerInterval = setInterval(updateMainTimer, 1000);
            updateMainTimer(); 
        }

        // ... (renderCatalog, addToCart, decreaseQuantity, updateCartDisplay, tg.MainButton.onClick ·à≥·ã≠·âÄ·ã®·à© ·ã≠·âÄ·à´·àâ) ...
        
        // ********** Spin and Win ·åå·àù ·ä†·àò·ä≠·äï·ãÆ **********
        const prizes = [
            { text: "50 ·äê·å•·â•", color: "#FFC107", value: 50 },
            { text: "100 ·äê·å•·â•", color: "#4CAF50", value: 100 },
            { text: "150 ·äê·å•·â•", color: "#2196F3", value: 150 },
            { text: "200 ·äê·å•·â•", color: "#E91E63", value: 200 },
            { text: "250 ·äê·å•·â•", color: "#9C27B0", value: 250 },
            { text: "500 ·äê·å•·â•", color: "#FF5722", value: 500 },
            { text: "·â£·ã∂", color: "#F44336", value: 0 }, 
        ];
        
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spin-button');
        const attemptsLeftSpan = document.getElementById('attempts-left');
        const spinCountdownSpan = document.getElementById('spin-countdown');
        const spinTimerDisplay = document.getElementById('spin-timer-display');
        let spinTimerInterval = null;

        function updateSpinDisplay() {
            attemptsLeftSpan.textContent = spinAttempts;
            
            if (spinAttempts > 0) {
                spinButton.disabled = false;
                spinButton.textContent = "·ä•·àΩ·ä≠·à≠·ä≠·à©!";
                spinTimerDisplay.style.display = 'none';
                clearInterval(spinTimerInterval); 
            } else {
                spinButton.disabled = true;
                spinButton.textContent = "·ã≠·å†·â•·âÅ...";

                spinTimerDisplay.style.display = 'block'; 
                
                if (spinResetTime > 0) { 
                     startSpinCountdown();
                } else {
                     clearInterval(spinTimerInterval); 
                     spinCountdownSpan.textContent = "·ä®Backend ·ã≥·â≥ ·â†·àò·å†·â†·âÖ ·àã·ã≠..."; 
                }
            }
        }
        
        function startSpinCountdown() {
             spinTimerDisplay.style.display = 'block';
             clearInterval(spinTimerInterval); 

             function updateTimer() {
                const elapsed = Date.now() - spinResetTime; 
                const remaining = DAILY_RESET_MS - elapsed;

                if (remaining <= 0) {
                    clearInterval(spinTimerInterval);
                    spinTimerDisplay.style.display = 'none';
                    
                    // Spin ·ã≥·åç·àù ·àõ·àµ·åÄ·àò·à≠ ·â•·âª
                    fetch(NETLIFY_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: "request_spin_reset", 
                            user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN" 
                        })
                    }).then(r => r.json()).then(processBotResponse).catch(e => console.error("Reset Fetch Error:", e));
                    
                    updateSpinDisplay();
                    return;
                }

                const totalSeconds = Math.floor(remaining / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                spinCountdownSpan.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            spinTimerInterval = setInterval(updateTimer, 1000);
            updateTimer(); 
        }
        
        function drawWheel() {
            // ... (drawWheel ·à≥·ã≠·âÄ·ã®·à≠ ·ã≠·âÄ·à´·àç)
            const totalPrizes = prizes.length;
            const arcSize = (2 * Math.PI) / totalPrizes;
            const radius = canvas.width / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            prizes.forEach((prize, i) => {
                const angle = i * arcSize;
                ctx.beginPath();
                ctx.arc(radius, radius, radius, angle, angle + arcSize);
                ctx.lineTo(radius, radius);
                ctx.fillStyle = prize.color;
                ctx.fill();
                
                ctx.save();
                ctx.fillStyle = "white";
                ctx.font = "bold 12px Arial";
                ctx.translate(radius, radius);
                ctx.rotate(angle + arcSize / 2);
                ctx.textAlign = "right";
                ctx.fillText(prize.text, radius * 0.8, 5);
                ctx.restore();
            });
        }

        function spinWheel() {
             if (spinAttempts <= 0 || spinButton.disabled) {
                tg.showAlert("‚ö†Ô∏è ·âÄ·à™ ·àô·ä®·à´ ·ã®·àà·ãé·âµ·àù·ç¢ ·ä•·â£·ä≠·ãé ·ã≠·å†·â•·âÅ·ç¢");
                return;
            }
            
            spinButton.disabled = true;
            spinButton.textContent = "·â†·àõ·àΩ·ä®·à≠·ä®·à≠ ·àã·ã≠...";
            
            // ********** üí° Backend ·ã®·àö·ãà·àµ·ã∞·ãç ·ä≠·çç·àç üí° **********
             const spinData = {
                action: "spin_attempt", 
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER",
                prize_options: prizes.map(p => p.value)
            };
            
            // üí° ·ãà·à≥·äù ·àà·ãç·å•: ·â†·âÄ·å•·â≥ ·ãà·ã∞ Netlify Function URL ·àò·àã·ä≠
            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(spinData)
            })
            .then(r => r.json())
            .then(processBotResponse)
            .catch(e => {
                 console.error("Spin Fetch Error:", e);
                 spinButton.disabled = false;
                 spinButton.textContent = "·ä•·àΩ·ä≠·à≠·ä≠·à©!";
                 tg.showAlert("‚ùå ·àΩ·ä≠·à≠·ä≠·à™·âµ ·à≤·å†·ã®·âÖ ·âΩ·åç·à≠ ·â∞·çà·å†·à®!");
            });
             
             // ·àà·â∞·å†·âÉ·àö·ãç ·àõ·à≥·ã´·äê·âµ ·ä•·äï·ã≤·àΩ·ä®·à®·ä®·à≠ ·àõ·ãµ·à®·åç (·ãç·å§·â± ·åç·äï ·â†Backend ·ã≠·ãà·à∞·äì·àç)
             const totalRotations = 5; 
             const randomStopIndex = Math.floor(Math.random() * prizes.length); 
             const rotationDegree = 360 * totalRotations + (360 - (randomStopIndex * (360 / prizes.length)) - (360 / prizes.length / 2));
             canvas.style.transform = `rotate(${rotationDegree}deg)`;
             
             // Frontend ·ä†·àÅ·äï ·ã® Backend ·àù·àã·àΩ·äï ·ã≠·å†·â•·âÉ·àç
        }
        
        function initializeSpinWheel() {
            drawWheel();
            updateSpinDisplay();
            spinButton.onclick = spinWheel;
        }
        
        // ********** Quiz ·ä†·àò·ä≠·äï·ãÆ **********
        let quizTimerInterval = null;
        
        function updateQuizDisplay() {
            document.getElementById('quiz-attempts-left').textContent = quizAttempts;
            const quizButton = document.querySelector('#quiz-details .green-button');
            
            if (quizAttempts > 0) {
                quizButton.disabled = false;
                quizButton.textContent = "·ãï·ãç·âÄ·âµ·ãé·äï ·ã≠·àû·ä≠·à© (+50 ·äê·å•·â•)";
                document.getElementById('quiz-timer-display').style.display = 'none';
                clearInterval(quizTimerInterval); 
            } else {
                quizButton.disabled = true;
                quizButton.textContent = "·ã≠·å†·â•·âÅ...";
                document.getElementById('quiz-timer-display').style.display = 'block'; 
                
                if (quizResetTime > 0) { 
                     startQuizCountdown();
                } else {
                     clearInterval(quizTimerInterval); 
                     document.getElementById('quiz-countdown').textContent = "·ä®Backend ·ã≥·â≥ ·â†·àò·å†·â†·âÖ ·àã·ã≠..."; 
                }
            }
        }
        
        function startQuizCountdown() {
             document.getElementById('quiz-timer-display').style.display = 'block';
             clearInterval(quizTimerInterval); 

             function updateTimer() {
                const elapsed = Date.now() - quizResetTime; 
                const remaining = DAILY_RESET_MS - elapsed;

                if (remaining <= 0) {
                    clearInterval(quizTimerInterval);
                    document.getElementById('quiz-timer-display').style.display = 'none';
                    
                    // Quiz ·ã≥·åç·àù ·àõ·àµ·åÄ·àò·à≠ ·â•·âª
                    fetch(NETLIFY_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: "request_quiz_reset", 
                            user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN" 
                        })
                    }).then(r => r.json()).then(processBotResponse).catch(e => console.error("Quiz Reset Fetch Error:", e));
                    
                    updateQuizDisplay();
                    return;
                }

                const totalSeconds = Math.floor(remaining / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                document.getElementById('quiz-countdown').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            quizTimerInterval = setInterval(updateTimer, 1000);
            updateTimer(); 
        }

        function updatePointsDisplay(newPoints) {
            currentPoints = newPoints;
            document.getElementById('user-points').textContent = currentPoints;
        }

        // ********** ·ã®·àõ·àÖ·â†·à´·ãä Tasks ·ä†·àò·ä≠·äï·ãÆ **********
        function updateTaskDisplay(tasksStatus) {
            socialTasksStatus = tasksStatus; 
            // ... (updateTaskDisplay ·à≥·ã≠·âÄ·ã®·à≠ ·ã≠·âÄ·à´·àç)
            for (const taskId in tasksStatus) {
                const taskElementId = `task-${taskId.toLowerCase().replace('_', '-')}`;
                const item = document.getElementById(taskElementId);
                const button = item ? item.querySelector('.task-button') : null;
                const originalText = button ? button.dataset.taskText : '';

                if (tasksStatus[taskId].completed) {
                    if (button) {
                        button.textContent = "·â∞·å†·äì·âã·àç ‚úîÔ∏è";
                        button.disabled = true;
                        button.style.backgroundColor = '#6c757d'; 
                    }
                } else if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = '#28a745';
                }
            }
        }
        
        function handleTaskClick(taskId, url) {
             // ... (handleTaskClick ·à≥·ã≠·âÄ·ã®·à≠ ·ã≠·âÄ·à´·àç)
             if (socialTasksStatus[taskId] && socialTasksStatus[taskId].completed) {
                tg.showAlert("·ã≠·àÖ·äï ·â∞·åç·â£·à≠ ·ä†·àµ·âÄ·ãµ·àò·ãç ·ä†·å†·äì·âÄ·ãã·àç!");
                return;
            }

            tg.openLink(url);
            
            tg.showConfirm(
                "·âª·äì·àâ·äï ·ä®·â∞·âÄ·àã·âÄ·àâ/·à∞·â•·àµ·ä≠·à´·ã≠·â• ·ä´·ã∞·à®·åâ ·â†·äã·àã '·ä•·à≠·åç·å†·äõ ·äê·äù' ·ã®·àö·àà·ãç·äï ·ã≠·å´·äë·ç¢", 
                (isConfirmed) => {
                    if (isConfirmed) {
                        const button = document.querySelector(`[data-task-id="${taskId}"]`);
                        
                        const verificationData = {
                            action: "verify_social_task",
                            task_id: taskId,
                            user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER" 
                        };
                        
                        // üí° ·ãà·à≥·äù ·àà·ãç·å•: ·â†·âÄ·å•·â≥ ·ãà·ã∞ Netlify Function URL ·àò·àã·ä≠
                         fetch(NETLIFY_FUNCTION_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(verificationData)
                        })
                        .then(r => r.json())
                        .then(processBotResponse)
                        .catch(e => {
                            console.error("Task Verification Fetch Error:", e);
                            tg.showAlert("‚ùå Task ·à≤·à®·åã·åà·å• ·âΩ·åç·à≠ ·â∞·çà·å†·à®!");
                        });
                        
                        tg.showAlert("·å•·ã´·âÑ·ãé ·â∞·àç·ä≥·àç·ç¢ ·âµ·ä≠·ä≠·àà·äõ·äê·âµ·ãé·äï ·ä•·àµ·ä™·ã´·à®·åã·åç·å• ·ã≠·å†·â•·âÅ!");

                        if (button) {
                            button.disabled = true;
                            button.textContent = "·â†·àõ·à®·åã·åà·å• ·àã·ã≠...";
                            button.style.backgroundColor = '#ffc107'; 
                        }

                    } else {
                        tg.showAlert("·ä•·à≠·åç·å†·äõ ·äê·äù ·à≥·ã≠·å´·äë ·ä®·ãà·å° ·àõ·à®·åã·åà·å´·ãç ·ä†·ã≠·à∞·à´·àù!");
                    }
                }
            );
        }

        // ********** ·ãï·àà·â≥·ãä ·åâ·à≠·àª ·ä†·ã´·ã´·ãù **********
        function updateDailyBonusDisplay() {
            const button = document.getElementById('daily-claim-button');
            const statusText = document.getElementById('daily-claim-status');
            if (!button) return; 
            
            const now = Date.now();
            const timeElapsed = now - dailyClaimTime;
            const eligible = timeElapsed >= DAILY_RESET_MS;
            
            if (eligible) {
                button.textContent = "·ãç·à∞·ãµ!";
                button.disabled = false;
                button.style.backgroundColor = '#4CAF50';
                button.setAttribute('data-claimed', 'false');
                statusText.textContent = "·ã®·ä•·àà·â± ·äê·çÉ ·åâ·à≠·àª! (+500 ·äê·å•·â•)";
            } else {
                button.textContent = "·â∞·ãà·àµ·ã∑·àç ‚úîÔ∏è";
                button.disabled = true;
                button.style.backgroundColor = '#6c757d';
                 button.setAttribute('data-claimed', 'true');
                 statusText.textContent = "·àà·àö·âÄ·å•·àà·ãç 24 ·à∞·ãì·âµ ·ã≠·å†·â•·âÅ·ç¢";
            }
        }
        
        function handleDailyClaim() {
            // Frontend ·â† Backend ·ã®·â∞·àã·ä®·ãç·äï ·à∞·ãì·âµ ·â†·àò·å†·âÄ·àù ·àò·åÄ·àò·à™·ã´ ·ã´·à®·åã·åç·å£·àç
            const now = Date.now();
            const timeElapsed = now - dailyClaimTime;
            
            if (timeElapsed < DAILY_RESET_MS) {
                 tg.showAlert("‚ö†Ô∏è ·ã®·ãï·àà·â≥·ãä ·àΩ·àç·àõ·âµ·ãé·äï ·ä†·àµ·âÄ·ãµ·àò·ãç ·ãà·àµ·ã∞·ãã·àç·ç¢ ·ä•·â£·ä≠·ãé ·àà·àö·âÄ·å•·àà·ãç 24 ·à∞·ãì·âµ ·ã≠·å†·â•·âÅ·ç¢");
                 return;
            }
            
            const button = document.getElementById('daily-claim-button');
            button.disabled = true;
            button.textContent = "·â†·àõ·àµ·çà·çÄ·àù ·àã·ã≠...";
            button.style.backgroundColor = '#ffc107'; 
            
            // ·ã®·åâ·à≠·àª ·å•·ã´·âÑ ·ãà·ã∞ Backend ·àò·àã·ä≠
            const claimData = {
                action: "claim_daily_bonus", 
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER"
            };
            
            // üí° ·ãà·à≥·äù ·àà·ãç·å•: ·â†·âÄ·å•·â≥ ·ãà·ã∞ Netlify Function URL ·àò·àã·ä≠
            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(claimData)
            })
            .then(r => r.json())
            .then(processBotResponse)
            .catch(e => {
                console.error("Daily Claim Fetch Error:", e);
                tg.showAlert("‚ùå ·åâ·à≠·àª ·à≤·å†·ã®·âÖ ·âΩ·åç·à≠ ·â∞·çà·å†·à®!");
                 button.disabled = false;
                 button.textContent = "·ãç·à∞·ãµ!";
                 button.style.backgroundColor = '#4CAF50';
            });
        }

        // ************************************************************************


        // ********** ·â† Tasks ·åà·åΩ ·àã·ã≠ ·ã´·àâ ·ä≠·çç·àé·âΩ·äï ·àò·âÄ·ã´·ã®·à≠ **********
        function showTaskSection(sectionId) {
            document.querySelectorAll('#tasks-page .info-card, #tasks-page .task-row-card').forEach(section => {
                // ·ãã·äì ·ä†·ãù·à´·àÆ·âΩ·äï ·ä•·äì ·ã®·åä·ãú ·àò·âÅ·å†·à™·ã´·ãç·äï ·ã≠·ã∞·â•·âÉ·àç
                if (section.id !== 'tasks-main-container' && !section.classList.contains('tasks-top-buttons') && !section.classList.contains('timer-display')) {
                    section.classList.add('hidden-section');
                }
            });

            // ·àÅ·àâ·äï·àù ·ãã·äì Tasks ·ã∞·â•·âÖ
             document.getElementById('earning-section').classList.add('hidden-section');
             document.getElementById('quiz-section-main').classList.add('hidden-section');
             document.getElementById('daily-bonus-main').classList.add('hidden-section');
             
            // ·ãã·äì·ãç ·åà·åΩ ·ä®·àÜ·äê ·àÅ·àâ·äï·àù ·ä†·à≥·ã≠
            if (sectionId === 'main-tasks') {
                 document.getElementById('earning-section').classList.remove('hidden-section');
                 document.getElementById('quiz-section-main').classList.remove('hidden-section');
                 document.getElementById('daily-bonus-main').classList.remove('hidden-section');
                 
                 document.getElementById('social-tasks-details').classList.add('hidden-section');
                 document.getElementById('quiz-details').classList.add('hidden-section');
                 
                 updateDailyBonusDisplay();
                 startMainCountdown();

            } else {
                // ·ãù·à≠·ãù·à≠ ·åà·åΩ ·ä®·àÜ·äê
                const selectedSection = document.getElementById(sectionId);
                if (selectedSection) {
                    selectedSection.classList.remove('hidden-section');
                }
            }
            
            if (sectionId === 'spin-section') {
                initializeSpinWheel();
            } else if (sectionId === 'social-tasks-details') {
                updateTaskDisplay(socialTasksStatus); 
            } else if (sectionId === 'quiz-details') {
                updateQuizDisplay();
            }
        }
        
        // ·àà Task Row Cards ·ä≠·àä·ä≠
        function showDetailTask(detailId) {
            showTaskSection(detailId);
        }
        // ************************************************************************


        // ********** ·ä®·â¶·â± ·ã®·àö·àò·å£·ãç·äï ·àù·àã·àΩ ·ã®·àö·âÜ·å£·å†·à≠ ·ãã·äì ·â∞·åç·â£·à≠ **********
        function processBotResponse(data) {
            
            // 1. ·ã®·åà·åΩ ·àõ·àµ·åÄ·àò·à≠·ã´ ·ã≥·â≥
            if (data.action === "initial_data") {
                // ... (Profile update, Points update)
                 updatePointsDisplay(data.points || 0);
                
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    const username = user.username || (user.first_name + " " + (user.last_name || "")).trim();
                    document.getElementById('display-username').textContent = username;
                    document.getElementById('profile-initial').textContent = username.charAt(0).toUpperCase();
                }
                
                // Spin Data
                spinAttempts = data.spin_data.attempts || 0;
                spinResetTime = data.spin_data.last_spin || 0;
                
                // Quiz Data (·ä†·ã≤·àµ)
                quizAttempts = data.quiz_data.attempts || 0;
                quizResetTime = data.quiz_data.last_quiz || 0;
                
                updateTaskDisplay(data.tasks_status || {}); 
                
                if (data.daily_bonus) {
                     dailyClaimTime = data.daily_bonus.last_claim || 0; 
                }

                // TWA ·ä®·â∞·ä®·çà·â∞ ·â†·äã·àã ·ã≥·â≥·ãç ·à≤·àò·å£ UI·äï ·ä†·ãò·àù·äï
                updateSpinDisplay();
                updateDailyBonusDisplay();
                updateQuizDisplay();
                startMainCountdown();
                
            }
            
            // 2. ·ã®·àõ·àÖ·â†·à´·ãä Tasks ·àõ·à®·åã·åà·å´ ·àù·àã·àΩ
            else if (data.action === "task_verified" && data.task_id) {
                 // ... (Task verification logic)
                 const button = document.querySelector(`[data-task-id="${data.task_id}"]`);
                 const originalText = button.dataset.taskText || (data.task_id === 'YT_SUB' ? '·à∞·â•·àµ·ä≠·à´·ã≠·â•' : '·â∞·âÄ·àã·âÄ·àç!');

                if (data.success) {
                    updatePointsDisplay(data.new_points || currentPoints); 
                    
                    if (socialTasksStatus[data.task_id]) {
                        socialTasksStatus[data.task_id].completed = true;
                    }
                    updateTaskDisplay(socialTasksStatus); 
                    tg.showAlert(`‚úÖ Task ·â∞·å†·äì·âã·àç! ${data.points_gained || 0} ·äê·å•·â• ·åà·â•·â∂·àç·ãé·â≥·àç!`);
                } else {
                    tg.showAlert("‚ö†Ô∏è ·àõ·à®·åã·åà·å´·ãç ·ä†·àç·â∞·à≥·ä´·àù·ç¢ ·âª·äì·àâ·äï/·åç·à©·çë·äï ·â†·âµ·ä≠·ä≠·àç ·â∞·âÄ·àã·âÖ·àà·ãã·àç?!");
                    
                    if (button) {
                         button.disabled = false;
                         button.textContent = originalText;
                         button.style.backgroundColor = '#28a745';
                    }
                }
            } 
            
            // 3. ·ã®Spin Wheel ·àù·àã·àΩ (Backend ·ãç·å§·â±·äï ·à≤·ãà·àµ·äï)
            else if (data.action === "spin_result") {
                 // ... (Spin result logic)
                const wonPrizeValue = data.points_won;
                const wonPrize = prizes.find(p => p.value === wonPrizeValue);
                const prizeText = wonPrize ? wonPrize.text : `${wonPrizeValue} ·äê·å•·â•`;

                 const totalRotations = 5; 
                 const winningIndex = prizes.findIndex(p => p.value === wonPrizeValue);
                 const rotationDegree = 360 * totalRotations + (360 - (winningIndex * (360 / prizes.length)) - (360 / prizes.length / 2));
                 canvas.style.transform = `rotate(${rotationDegree}deg)`;
                 
                 setTimeout(() => {
                    updatePointsDisplay(data.new_points || currentPoints); 
                    spinAttempts = data.attempts_left || 0; 
                    spinResetTime = data.last_spin || 0; 
                    
                    if (wonPrizeValue > 0) {
                        tg.showAlert(`üéâ ·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·àÖ! ${prizeText} ·ä†·à∏·äï·çà·ãã·àç!`);
                    } else {
                        tg.showAlert(`üòî ${prizeText} ·ä†·åã·å•·àû·àÉ·àç·ç¢ ·àà·àö·âÄ·å•·àà·ãç ·åä·ãú ·àû·ä≠·à≠!`);
                    }
                    
                    spinButton.disabled = false;
                    if (spinAttempts > 0) { 
                        spinButton.textContent = "·ä•·àΩ·ä≠·à≠·ä≠·à©!";
                    }
                    
                    updateSpinDisplay(); 
                    startMainCountdown();
                 }, 5500); 
                 
            }
            
            // 4. ·ã®·ä≠·çç·ã´ ·àõ·à®·åã·åà·å´ ·àù·àã·àΩ
            else if (data.action === "payment_confirmed") {
                // ... (Payment logic)
                if (data.success) {
                    tg.showAlert(`üéâ ·ä≠·çç·ã´·ãé ·â∞·à≥·ä≠·â∑·àç! ${data.amount} ·â•·à≠ ·â∞·âÄ·â•·àà·äì·àç·ç¢ ·àò·åΩ·àê·çç·ãé ·àä·àà·âÄ·âÖ ·äê·ãç!`);
                    cart = [];
                    totalPrice = 0;
                    updateCartDisplay();
                    tg.MainButton.setText(`·ä≠·çç·ã´ ·ã≠·çà·åΩ·àô: 0.00 ·â•·à≠`).hide();
                } else {
                    tg.showAlert("‚ùå ·ä≠·çç·ã´·ãé ·ä†·àç·â∞·à≥·ä´·àù·ç¢ ·ä•·â£·ä≠·ãé ·ä•·äï·ã∞·åà·äì ·ã≠·àû·ä≠·à©·ç¢");
                    updateCartDisplay(); 
                }
            }
             // 5. ·àô·ä®·à´·ãé·âΩ ·ä®24 ·à∞·ãì·âµ ·â†·äã·àã ·à≤·ã´·ãµ·à±
            else if (data.action === "attempts_refreshed" || data.action === "full_reset") {
                spinAttempts = data.spin_data.attempts || 0; 
                spinResetTime = data.spin_data.last_spin || 0;
                quizAttempts = data.quiz_data.attempts || 0;
                quizResetTime = data.quiz_data.last_quiz || 0;
                
                updateSpinDisplay();
                updateQuizDisplay();
                startMainCountdown();
                tg.showAlert("‚úÖ ·ãï·àà·â≥·ãä Tasks·ãé ·â≥·ãµ·à∞·ãã·àç!");
            }
            
            // 6. ·ãï·àà·â≥·ãä ·åâ·à≠·àª
            else if (data.action === "daily_bonus_claimed") {
                 // ... (Daily bonus logic)
                if (data.success) {
                    updatePointsDisplay(data.new_points || currentPoints);
                    dailyClaimTime = data.last_claim || Date.now(); 
                    
                    tg.showAlert(`üéâ ·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·àÖ! ·ã®·ãï·àà·â± 500 ·äê·å•·â• ·åà·â•·â∂·àç·ãé·â≥·àç!`);
                } else {
                    tg.showAlert("‚ùå ·ã®·ãï·àà·â≥·ãä ·àΩ·àç·àõ·âµ ·å•·ã´·âÑ·ãé ·ä†·àç·â∞·à≥·ä´·àù·ç¢ (·àù·äì·àç·â£·âµ ·ä†·àµ·âÄ·ãµ·àò·ãç ·ãà·àµ·ã∞·ãã·àç?)");
                }
                
                updateDailyBonusDisplay(); // UI·äï ·ä†·ãò·àù·äï
                startMainCountdown();
            }
            
            // 7. ·àå·àé·âΩ ·ã®·äê·å•·â• ·àò·å®·àò·à≠ ·àù·àã·àæ·âΩ (·àà·àù·à≥·àå ·ä®Quiz)
            else if (data.action === "points_added") {
                updatePointsDisplay(data.new_points || currentPoints); 
            }
        }

        // ·ã®·â¶·âµ ·àù·àã·àΩ ·ã®·àö·âÄ·â†·àà·ãç ·ãã·äì ·â∞·åç·â£·à≠ (·ã≠·àÖ ·ã®·àö·à∞·à´·ãç Bot·ãç web_app_data ·à≤·àò·àç·àµ ·â•·âª ·äê·ãç)
        tg.onEvent('web_app_data', (event) => {
            try {
                const data = JSON.parse(event.data);
                processBotResponse(data);
            } catch (e) {
                console.error("Error processing web_app_data:", e);
                tg.showAlert("·ä®·â¶·â± ·àò·àç·àµ ·à≤·âÄ·â†·àç ·âΩ·åç·à≠ ·â∞·çà·å•·àØ·àç! (·äÆ·äï·à∂·àç ·ã≠·àò·àç·ä®·â±)");
                if(spinButton) { 
                   spinButton.disabled = false; 
                   spinButton.textContent = "·ä•·àΩ·ä≠·à≠·ä≠·à©!";
                }
                updateCartDisplay(); 
            }
        });

        // ·àò·â∞·åç·â†·à™·ã´·ãç ·à≤·åÄ·àù·à≠ ·ã®·àö·å†·à© ·â∞·åç·â£·à´·âµ
        renderCatalog();
        loadInitialData(); // üí° ·ãà·à≥·äù: ·ä†·àÅ·äï Backend·äï ·â†·âÄ·å•·â≥ ·ã≠·å†·à´·àç
        
        switchPage('tasks'); // ·â† Tasks ·åà·åΩ ·ã≠·åÄ·àù·à´·àç

    </script>
</body>
</html>
