á‰£áˆµá‰¸áŠ³á‹­ áˆ›áˆµá‰°áŠ«áŠ¨áˆ á‹«áˆˆá‰¥á‹á‰µáŠ• áŠáŒˆáˆ®á‰½ áˆáˆ‰ áŠ áˆµá‰°áŠ«áŠ­á‹¬ áŠ®á‹±áŠ• áŠ¨á‰³á‰½ áŠ áˆµá‰€áˆáŒ«áˆˆáˆá¢
á‹‹áŠ“á‹ á‰µáŠ©áˆ¨á‰µ á‹¨á‰°á‹°áˆ¨áŒˆá‹á¡-
 * "áŠ¨Backend data á‰ áˆ˜áŒ á‰ á‰… áˆ‹á‹­..." á‹¨áˆšáˆˆá‹áŠ• áŒ½áˆ‘á áˆˆáˆ›áˆµá‰€áˆ¨á‰µ áŠ¥áŠ“ áŒˆáŒ¹ áˆ²áŠ¨áˆá‰µ á‹ˆá‹²á‹«á‹áŠ‘ á‹¨ Spin áŠ¥áŠ“ Quiz áˆ™áŠ¨áˆ«á‹á‰½ áˆ™áˆ‰ (5/5) áŠ¥áŠ•á‹²áˆ†áŠ‘ áˆ›á‹µáˆ¨áŒá¢
 * á‹¨ Tasks áŒˆáŒ½ áˆ²áŠ¨áˆá‰µ á‹ˆá‹²á‹«á‹áŠ‘ á‹¨á‹•áˆˆá‰³á‹Š áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹ (Main Timer) á‰ á‰µáŠ­áŠ­áˆ áŠ¥áŠ•á‹²áŒ€áˆáˆ­ áˆ›á‹µáˆ¨áŒ (áŠ¨á‰¦á‰³ áˆ˜á‹«á‹£ áŠ¥áˆ´á‰¶á‰½ á‰ áˆ˜áŠáˆ³á‰µ)á¢
 * á‹¨á‰°áˆ»áˆ»áˆ‰á‰µáŠ• á‹¨áŒƒá‰«áˆµáŠ­áˆªá•á‰µ á‰°áˆˆá‹‹á‹‹áŒ®á‰½ á‰ á‰°áˆ˜áˆˆáŠ¨á‰° á‹«áˆ‰á‰µáŠ• áŠ áˆµá‰°á‹«á‹¨á‰¶á‰½ á‰ áŒáˆáŒ½ áˆ›áˆµá‰€áˆ˜áŒ¥á¢
ğŸ› ï¸ á‹¨á‰°áˆµá‰°áŠ«áŠ¨áˆˆá‹ index.html áŠ®á‹µ
áŠ¨á‹šáˆ… á‰ á‰³á‰½ áˆ™áˆ‰ á‰ áˆ™áˆ‰ á‹¨á‰°áˆµá‰°áŠ«áŠ¨áˆˆá‹ á‹¨ index.html áŠ®á‹µ á‰€áˆ­á‰§áˆá¢
<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School áˆ‹á‹­á‰¥áˆ¨áˆª Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* á‹¨áˆµá‰³á‹­áˆ áŠ®á‹µ áˆ³á‹­á‰€á‹¨áˆ­ á‹­á‰€áˆ«áˆ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            padding-bottom: 70px; 
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #333);
        }
        h1, h2, h3 {
            color: var(--tg-theme-link-color, #007bff);
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .hidden-page {
            display: none !important;
        }
        
        /* áŠ á‹²áˆµ áˆµá‰³á‹­áˆ: á‰ á‰…á‹°áˆ á‰°áŠ¨á‰°áˆ á‹¨áˆšáŠ¨áˆá‰± áŠ­ááˆá‰½áŠ• áˆˆáˆ˜á‹°á‰ á‰… */
        .hidden-section {
            display: none !important;
        }
        
        /* ********** á‹¨áŒ‹áˆ« áˆµá‰³á‹­áˆá‰½ ********** */
        .info-card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            margin: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-bg-color, #eee);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .green-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        .red-button { /* áˆˆLogout */
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
        }

        /* ********** Task áŠ á‹²áˆµ áˆµá‰³á‹­áˆá‰½ (áŠ¥áŠ•á‹° áˆáˆµáˆ‰) ********** */
        
        /* áˆˆáˆ‹á‹­áŠ›á‹ á‹¨áŒŠá‹œ á‰†áŒ£áˆª */
        .timer-container {
            display: flex;
            justify-content: center;
            padding: 15px 0;
            font-size: 2em;
            font-weight: bold;
            color: #FFC107; /* á‰¢áŒ« á‰€áˆˆáˆ™áŠ• áˆˆáˆ›áˆáŒ£á‰µ */
        }
        .time-segment {
            background-color: #333; /* áŒ¥á‰áˆ­ á‹³áˆ« */
            color: #FFC107;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 5px;
        }

        /* áˆˆá‹‹áŠ“á‹á‰¹ áŠ á‹áˆ«áˆ®á‰½ (Contest, Spin, Coupon) */
        .main-task-buttons {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
        }
        .task-action-button {
            width: 30%;
            height: 100px;
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .task-action-button i {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .daily-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #dc3545; /* á‰€á‹­ */
            color: white;
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 0.7em;
        }
        /* áˆá‹© á‰€áˆˆáˆá‰½ */
        #contest-btn { background-color: #FFC107; color: #333; } 
        #spin-btn { background-color: #28a745; }
        #coupon-btn { background-color: #6f42c1; }

        /* áˆˆ ROAD áŠ¥áŠ“ 100X áŠ­ááˆá‰½ */
        .reward-section {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            margin: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .reward-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-bg-color, #eee);
        }
        .reward-item:last-child { border-bottom: none; }
        .reward-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            font-weight: bold;
        }
        #road-icon { background-color: #dc3545; } 
        #quiz-icon { background-color: #6f42c1; } 
        
        .reward-info h4 {
            margin: 0 0 2px 0;
            color: var(--tg-theme-text-color, #333);
        }
        .reward-info p {
            margin: 0;
            font-size: 0.9em;
            color: var(--tg-theme-hint-color, #999);
        }
        .action-button {
            margin-left: auto; 
            background-color: #FFC107;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* áˆˆSpin Wheel áˆµá‰³á‹­áˆá‰½ */
        #wheelCanvas {
            /* ğŸ’¡ áŠ áŠ’áˆœáˆ½áŠ‘ á‹¨áˆšáŒ€áˆ˜áˆ­á‰ á‰µáŠ• á‰¦á‰³ á‹ˆá‹° 0deg á‰ áˆ›á‹áˆ­ áˆ›áˆµá‰°áŠ«áŠ¨áˆ */
            transform: rotate(0deg); 
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); 
            background-color: var(--tg-theme-bg-color, #eee);
            border-radius: 50%;
        }
        .spin-container {
             display: none; /* áˆ˜áŒ€áˆ˜áˆªá‹« á‹­á‹°á‰ á‰ƒáˆ */
             text-align: center;
             padding: 20px;
             background-color: var(--tg-theme-secondary-bg-color, #ffffff);
             border-radius: 10px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
             margin-top: 15px;
        }
        .task-list {
            padding: 0;
            list-style: none;
        }
        
        #pointer {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 10px solid transparent; 
            border-right: 10px solid transparent; border-bottom: 20px solid #dc3545;
        }

        /* ********** á‹¨á‰³á‰½áŠ›á‹ á‹³áˆ°áˆ³ áˆµá‰³á‹­áˆ (Bottom Nav) ********** */
        #bottom-nav {
            position: fixed; 
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex; 
            justify-content: space-around; 
            padding: 5px 0 10px 0; 
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-bg-color, #eee);
            z-index: 100; 
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05); 
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #999);
            font-size: 0.8em;
            padding: 5px;
            user-select: none;
        }
        .nav-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            margin-bottom: 2px;
        }
        .nav-item.active {
            color: var(--tg-theme-link-color, #007bff); 
        }
        .nav-item.active .nav-icon {
            background-color: var(--tg-theme-link-color, #007bff); 
        }
        .nav-item.active i {
            color: var(--tg-theme-secondary-bg-color, #ffffff); 
        }
        
        /* ********** áŠ á‹²áˆµ á‹¨ Top Page áˆµá‰³á‹­áˆá‰½ ********** */
        #top-page {
            margin: -10px;
            padding: 0;
            padding-bottom: 70px;
            overflow-y: auto; /* Scroll áŠ¥áŠ•á‹²á‹«á‹°áˆ­áŒ */
        }
        .top-header {
            background-color: #6f42c1; /* áˆˆáˆ‹á‹­áŠ›á‹ áŠ­ááˆ áŒ¥á‰áˆ­ áˆáˆáˆ«á‹Š */
            color: white;
            padding: 20px 0;
            text-align: center;
            position: relative;
            min-height: 250px;
            overflow: hidden;
        }
        .animation-header {
             /* á‹­áˆ… á‰¦á‰³ áˆˆáˆáˆµáˆ‰ áŠá‹ */
             width: 100%;
             height: 150px;
             background-color: #5d3891; 
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 1.5em;
             margin-bottom: 10px;
        }
        .user-stats {
            display: flex;
            justify-content: space-around;
            padding: 10px 20px;
            background-color: #5d3891;
            border-radius: 10px;
            margin: 0 15px 15px 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #FFC107; 
        }
        .stat-label {
            font-size: 0.8em;
            color: #ccc;
        }
        .wallet-button {
             background-color: #FFC107;
             color: #333;
             border: none;
             padding: 12px 25px;
             border-radius: 25px;
             cursor: pointer;
             font-weight: bold;
             font-size: 1.1em;
             margin-top: 10px;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .leaderboard-list {
            padding: 0 15px;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            width: 30px;
            text-align: center;
            color: #6f42c1;
        }
        .leaderboard-item:nth-child(1) .leaderboard-rank { color: gold; }
        .leaderboard-item:nth-child(2) .leaderboard-rank { color: silver; }
        .leaderboard-item:nth-child(3) .leaderboard-rank { color: #cd7f32; /* Bronze */ }

        .leaderboard-info {
            flex-grow: 1;
        }
        .leaderboard-name {
            font-weight: bold;
            margin: 0;
            color: var(--tg-theme-text-color, #333);
        }
        .leaderboard-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>

    <audio id="spin-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-spin-button-1946.mp3" preload="auto"></audio> 

    <div id="shop-page">
        <div id="cart-container" class="info-card">
            <h2>ğŸ›’ á‹¨áˆ±á‰… áˆ›á‹•áŠ¨áˆ</h2>
            <ul id="cart-items" style="list-style: none; padding: 0;"></ul>
            <h3>áŒ á‰…áˆ‹áˆ‹ á‹µáˆáˆ­: <span id="total-price">0.00</span> á‰¥áˆ­</h3>
        </div>
        <div id="catalog"></div>
    </div>
    
    <div id="profile-page" class="hidden-page" style="margin: -10px; padding: 0;">
        <div id="profile-header">
            <div class="profile-icon" id="profile-initial">?</div>
            <p class="profile-username" id="display-username">Loading...</p>
        </div>

        <div class="info-card">
            <div class="info-item">
                <span class="item-label"><i class="fas fa-dollar-sign"></i> á‰€áˆª áˆ‚áˆ³á‰¥ (Balance)</span>
                <span class="item-value">0.00 á‰¥áˆ­</span> 
                <button class="green-button" onclick="alert('áŒˆáŠ•á‹˜á‰¥ áˆ›á‹áŒ£á‰µ á‰°áŒá‰£áˆ­ á‰ á‰¦á‰± áˆ˜á‹°áŒˆá áŠ áˆˆá‰ á‰µá¢');">Withdraw</button>
            </div>
            <div class="info-item">
                <span class="item-label"><i class="fas fa-star"></i> áˆ½áˆáˆ›á‰µ</span>
                <span class="item-value" id="user-points">0</span> </div>
             <div class="info-item">
                <span class="item-label"><i class="fas fa-ticket-alt"></i> Tickets</span>
                <span class="item-value">0</span>
            </div>
        </div>
        
         <div class="info-card">
             <div class="info-item">
                <span class="item-label"><i class="fas fa-wallet"></i> áŠ­áá‹«</span>
                <button class="green-button" onclick="alert('á‹¨áŠ­áá‹« á‹˜á‹´ á‰…áŠ•á‰¥áˆ®á‰½');">á‹¨áŠ­áá‹« á‹˜á‹´ ></button> 
            </div>
            
            <div class="info-item">
                <span class="item-label"><i class="fas fa-sync-alt"></i> áŠáŒ¥á‰¥ á‹ˆá‹° á‰¥áˆ­ á‰€á‹­áˆ­</span>
                <button class="green-button" onclick="alert('á‰ á‰…áˆ­á‰¥ á‰€áŠ• á‹­áŒ á‰¥á‰...');" style="background-color: #f0ad4e;">
                    Exchange
                </button> 
            </div>
            
            <div class="info-item">
                <span class="item-label"><i class="fas fa-globe"></i> á‰‹áŠ•á‰‹</span>
                <span class="item-value">áŠ áˆ›áˆ­áŠ› <i class="fas fa-chevron-down"></i></span>
            </div>
        </div>

        <div class="info-card">
            <button class="red-button" onclick="tg.close();">á‹áŒ‹</button>
        </div>
    </div>
    
    <div id="tasks-page" class="hidden-page" style="margin: -10px; padding: 0;">
        
        <div class="timer-container">
            <div class="time-segment" id="timer-hours">00</div>
            :
            <div class="time-segment" id="timer-minutes">00</div>
            :
            <div class="time-segment" id="timer-seconds">00</div>
        </div>

        <div class="main-task-buttons">
            <button id="contest-btn" class="task-action-button" onclick="alert('á‰ á‰…áˆ­á‰¥ á‰€áŠ• á‹­áŒ á‰¥á‰...');">
                <span class="daily-label">Daily</span>
                <i class="fas fa-trophy"></i>
                Contest
            </button>

            <button id="spin-btn" class="task-action-button" onclick="toggleSpinGame();">
                <i class="fas fa-gem"></i>
                Spin
            </button>

            <button id="coupon-btn" class="task-action-button" onclick="handleCouponClick();">
                <i class="fas fa-gift"></i>
                Coupon
            </button>
        </div>
        
        <div id="spin-game-area" class="spin-container">
            <h3>ğŸ á‹¨á‹›áˆ¬ á‹•á‹µáˆá‹! (Spin & Win)</h3>
            <div style="position: relative; width: 300px; height: 300px; margin: 20px auto;">
                <canvas id="wheelCanvas" width="300" height="300"></canvas>
                <div id="pointer"></div>
            </div>
            <button id="spin-button" class="green-button" style="padding: 15px 30px; font-size: 1.2em; width: 80%;">
                áŠ¥áˆ½áŠ­áˆ­áŠ­áˆ©!
            </button>
            <p style="margin-top: 15px;">á‰€áˆª áˆ™áŠ¨áˆ«á‹á‰½: <span id="attempts-left">...</span>/5</p>
            <p id="timer-display" style="color: #dc3545; font-weight: bold; margin-top: 10px; display: none;">
                á‹µáŒ‹áˆš áˆˆáˆ˜áŒ«á‹ˆá‰µ: <span id="countdown">...</span>
            </p>
        </div>


        <h3 style="padding-left: 15px; margin-top: 30px; color: var(--tg-theme-text-color);"> áŠáŒ¥á‰¥ áˆ›áŒáŠ›</h3>
        
        <div id="telegram-community-section" class="reward-section">
            <div class="reward-item" onclick="toggleTaskList('social-tasks-list');">
                <div id="road-icon" class="reward-icon">ROA<br>D</div>
                <div class="reward-info">
                    <h4>á‰´áˆŒáŒáˆ«áˆ Community</h4>
                    <p>á‰»áŠ“áˆ á‰ áˆ˜á‰€áˆ‹á‰€áˆ áŠáŒ¥á‰¥ á‹«áŒáŠ™</p>
                </div>
                <button class="action-button">á‰°á‰€áˆ‹á‰€áˆ</button>
            </div>
             <ul id="social-tasks-list" class="task-list hidden-section" style="padding: 10px 0;">
                 <div class="info-item" id="task-tg-ch">
                    <span class="item-label">
                        <i class="fab fa-telegram-plane" style="color: #0088cc; margin-right: 5px;"></i> 
                        **á‰´áˆŒáŒáˆ«áˆ á‰»áŠ“áˆ á‰°á‰€áˆ‹á‰€áˆ**
                    </span>
                    <span class="item-value">+150 áŠáŒ¥á‰¥</span>
                    <button class="green-button task-button" 
                            data-task-id="TG_CH" 
                            data-points="150"
                            data-url="https://t.me/ethio_schoollibrary"
                            onclick="handleTaskClick('TG_CH', 'https://t.me/ethio_schoollibrary');">
                        á‰°á‰€áˆ‹á‰€áˆ!
                    </button>
                </div>

                <div class="info-item" id="task-tg-gp">
                    <span class="item-label">
                        <i class="fab fa-telegram-plane" style="color: #00a4e4; margin-right: 5px;"></i> 
                        **á‰´áˆŒáŒáˆ«áˆ áŒáˆ©á• á‰°á‰€áˆ‹á‰€áˆ**
                    </span>
                    <span class="item-value">+100 áŠáŒ¥á‰¥</span>
                    <button class="green-button task-button" 
                            data-task-id="TG_GP" 
                            data-points="100"
                            data-url="https://t.me/school_library2012"
                            onclick="handleTaskClick('TG_GP', 'https://t.me/school_library2012');">
                        á‰°á‰€áˆ‹á‰€áˆ!
                    </button>
                </div>

                <div class="info-item" id="task-yt-sub" style="border-bottom: none;">
                    <span class="item-label">
                        <i class="fab fa-youtube" style="color: #ff0000; margin-right: 5px;"></i> 
                        **á‹©á‰²á‹©á‰¥ áˆ°á‰¥áˆµáŠ­áˆ«á‹­á‰¥**
                    </span>
                    <span class="item-value">+300 áŠáŒ¥á‰¥</span>
                    <button class="green-button task-button" 
                            data-task-id="YT_SUB" 
                            data-points="300"
                            data-url="YOUR_YOUTUBE_CHANNEL_LINK_HERE"
                            onclick="handleTaskClick('YT_SUB', 'YOUR_YOUTUBE_CHANNEL_LINK_HERE');">
                        áˆ°á‰¥áˆµáŠ­áˆ«á‹­á‰¥
                    </button>
                </div>
             </ul>
        </div>
        
        <div id="quiz-section" class="reward-section">
            <div class="reward-item" onclick="toggleQuizGame();">
                <div id="quiz-icon" class="reward-icon">100<br>X</div>
                <div class="reward-info">
                    <h4>á‹¨áŒ­áŠ•á‰…áˆ‹á‰µ áŒ¥á‹«á‰„á‹á‰½</h4>
                    <p>áŠ¥á‹á‰€á‰µá‹áŠ• á‰ áˆ˜áˆá‰°áŠ• áŠáŒ¥á‰¥ á‹«áŒáŠ™</p>
                </div>
                <button class="action-button">á‰°áŒ«á‹ˆá‰µ</button>
            </div>
             
             <div id="quiz-game-area" class="info-card hidden-section" style="margin: 15px 0 0 0; padding: 15px;">
                 <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 0; color: #6f42c1;">
                     <i class="fas fa-question-circle"></i> á‹“áˆˆáˆ áŠ á‰€á áŒ¥á‹«á‰„á‹á‰½
                 </h3>
                 <p>á‰€áˆª áˆ™áŠ¨áˆ«á‹á‰½: <span id="quiz-attempts-left">...</span>/5</p>
                 <button class="green-button" onclick="alert('á‰ á‰…áˆ­á‰¥ á‰€áŠ• á‹­áŒ á‰¥á‰ ...');" style="width: 100%; margin-top: 10px;">áŒ¥á‹«á‰„á‹áŠ• áŒ€áˆáˆ­!</button>
                 <p id="quiz-timer-display" style="color: #dc3545; font-weight: bold; margin-top: 15px; display: none;">
                    á‹µáŒ‹áˆš áˆˆáˆ˜áŒ«á‹ˆá‰µ: <span id="quiz-countdown">...</span>
                 </p>
             </div>
        </div>

    </div>
    
    <div id="top-page" class="hidden-page">
        <div class="top-header">
            <div class="animation-header">
                 
            </div>
            
            <button class="wallet-button" onclick="alert('Wallet Connect áŠ¥á‹¨á‰°áŒ áˆ« áŠá‹...');">
                <i class="fas fa-wallet"></i> Connect Wallet
            </button>
            
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-value" id="top-my-rank">...</div>
                    <div class="stat-label">Rank</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="top-my-balance">...</div>
                    <div class="stat-label">Balance</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="top-my-points">...</div>
                    <div class="stat-label">Points</div>
                </div>
            </div>
        </div>

        <h3 style="padding: 0 15px; margin-top: 10px; color: var(--tg-theme-text-color);">ğŸ† Leaderboard</h3>

        <div class="leaderboard-list" id="leaderboard-data">
            <p style="text-align: center; color: var(--tg-theme-hint-color);">á‰ áˆ›áˆµáŒˆá‰£á‰µ áˆ‹á‹­...</p>
        </div>
        
    </div>
    <div id="bottom-nav">
        <div class="nav-item" onclick="switchPage('tasks');">
            <div class="nav-icon"><i class="fas fa-bolt"></i></div>
            Tasks
        </div>
        <div id="shop-nav" class="nav-item active" onclick="switchPage('shop');">
            <div class="nav-icon"><i class="fas fa-shopping-bag"></i></div>
            Shop
        </div>
        <div class="nav-item" onclick="switchPage('top');">
            <div class="nav-icon"><i class="fas fa-crown"></i></div>
            Top
        </div>
        <div id="profile-nav" class="nav-item" onclick="switchPage('profile');">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            Profile
        </div>
    </div>
    

    <script>
        // 1. á‹¨á‰´áˆŒáŒáˆ«áˆ á‹Œá‰¥ áŠ á• á‹‹áŠ“ áŠáŒˆáˆ­
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        // ğŸ’¡ á‹¨á‰°áˆµá‰°áŠ«áŠ¨áˆˆá‹ á‹¨ Backend Function áŠ á‹µáˆ«áˆ»á‹!
        const NETLIFY_FUNCTION_URL = 'https://cheerful-gumption-78086f.netlify.app/.netlify/functions/tbot_handler';
        
        // 2. á‹¨áŠ«á‰³áˆáŒ áˆ˜áˆ¨áŒƒ áˆ˜á‹‹á‰…áˆ­ (Data)
        const bookData = [
            {
                category: "áˆ³á‹­áŠ•áˆµ",
                items: [
                    { id: "S001", name: "á‹¨áˆ¥áŠ-áˆ•á‹­á‹ˆá‰µ áˆ˜áˆ áˆ¨á‰¶á‰½", price: 150.00, pdf_id: "PDF_SC01", photo_url: "https://via.placeholder.com/80x100?text=S001" },
                    { id: "S002", name: "á‹¨áŠá‹šáŠ­áˆµ á‰µáˆáˆ…áˆ­á‰µ", price: 175.50, pdf_id: "PDF_SC02", photo_url: "https://via.placeholder.com/80x100?text=S002" },
                ]
            },
            {
                category: "áˆ¥áŠ áŒ½áˆ‘á",
                items: [
                    { id: "L001", name: "á‹¨áˆ€áŒˆáˆ­ áá‰…áˆ­ áŒáŒ¥áˆá‰½", price: 120.00, pdf_id: "PDF_LIT1", photo_url: "https://via.placeholder.com/80x100?text=L001" },
                    { id: "L002", name: "áŠ áŒ«áŒ­áˆ­ á‰³áˆªáŠ®á‰½", price: 110.00, pdf_id: "PDF_LIT2", photo_url: "https://via.placeholder.com/80x100?text=L002" },
                ]
            },
        ];

        let cart = [];
        let totalPrice = 0;
        
        // ********** áŠ¨ Backend á‹¨áˆšáˆ˜áŒ¡ á‰°áˆˆá‹‹á‹‹áŒ®á‰½ (á‰ á‰¦á‰± á‹³á‰³á‰¤á‹ áˆ‹á‹­ á‹¨á‰°á‰€áˆ˜áŒ¡) **********
        let currentPoints = 0; 
        let currentBalance = 0.00; // ğŸ’¡ áŠ á‹²áˆµ: á‹¨ Balance á‰¦á‰³
        let myRank = 175; // ğŸ’¡ áŠ á‹²áˆµ: á‹¨ Rank á‰¦á‰³ (Placeholder)
        
        // ğŸ’¡ áˆ›áˆµá‰°áŠ«áŠ¨á‹«: áŒˆáŒ¹ áˆ²áŠ¨áˆá‰µ "áŠ¨Backend data á‰ áˆ˜áŒ á‰ á‰… áˆ‹á‹­" á‹¨áˆšáˆˆá‹áŠ• áˆˆáˆ˜áŠ¨áˆ‹áŠ¨áˆ áŠ¥áŠ“ áˆ™áŠ¨áˆ«á‹á‰½ áŠ¥áŠ•á‹²á‰³á‹©
        const MAX_SPIN_ATTEMPTS = 5; 
        const MAX_QUIZ_ATTEMPTS = 5; 

        let spinAttempts = MAX_SPIN_ATTEMPTS; // á‹ˆá‹° áŠ¨áá‰°áŠ›á‹ áˆ™áŠ¨áˆ« (5) á‰°á‰€á‹­áˆ¯áˆ
        let spinResetTime = 0; // á‹¨áˆ˜áŒ¨áˆ¨áˆ»á‹ áˆµá’áŠ• á‹¨á‰°á‹°áˆ¨áŒˆá‰ á‰µ áŒŠá‹œ (0 áŠ¨áˆ†áŠ áˆ™áŠ¨áˆ« áŠ áˆˆ áˆ›áˆˆá‰µ áŠá‹)
        
        let socialTasksStatus = {}; 
        let dailyClaimTime = 0; // á‹¨áˆ˜áŒ¨áˆ¨áˆ»á‹ á‹•áˆˆá‰³á‹Š áŒ‰áˆ­áˆ» á‹¨á‰°á‹ˆáˆ°á‹°á‰ á‰µ áŒŠá‹œ (0 áŠ¨áˆ†áŠ áˆˆáˆ˜á‹áˆ°á‹µ á‹áŒáŒ áŠá‹)
        
        let quizAttempts = MAX_QUIZ_ATTEMPTS; // á‹ˆá‹° áŠ¨áá‰°áŠ›á‹ áˆ™áŠ¨áˆ« (5) á‰°á‰€á‹­áˆ¯áˆ
        let quizResetTime = 0; // á‹¨áˆ˜áŒ¨áˆ¨áˆ»á‹ áŒ¥á‹«á‰„ á‹¨á‰°á‹°áˆ¨áŒˆá‰ á‰µ áŒŠá‹œ
        
        let leaderboardData = []; // ğŸ’¡ áŠ á‹²áˆµ: áˆˆ Leaderboard á‹³á‰³
        
        const DAILY_RESET_MS = 24 * 60 * 60 * 1000;
        let spinTimerInterval = null;
        let quizTimerInterval = null;
        let taskTimerInterval = null; 
        
        // ************************************************************************


        // ********** á‹¨áˆ˜áŠáˆ» á‹³á‰³ áˆ˜áŒ«áŠ• (BackendáŠ• á‰ á‰€áŒ¥á‰³ á‹¨áˆšáŒ áˆ«) **********
        function loadInitialData() {
            // ğŸ’¡ initDataá‹áŠ• áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ áˆ˜áˆ‹áŠ­
            const initialDataRequest = {
                action: "request_initial_data",
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN",
                init_data: tg.initData 
            };

            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(initialDataRequest)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                processBotResponse(data);
            })
            .catch(error => {
                console.error('Frontend Fetch Error:', error);
                // tg.showAlert(`âŒ áŠ¨ Backend á‹³á‰³ áˆ²áŒ á‹¨á‰… á‰½áŒáˆ­ á‰°áˆáŒ áˆ¨! ${error.message} (Log á‹­áˆ˜áˆáŠ¨á‰±)`);
                // ğŸ’¡ á‹¨á•áˆŒáˆµáˆ†áˆá‹°áˆ­ á‹³á‰³ áˆ›áˆµáŒˆá‰£á‰µ (Backend á‰¢á‹˜áŒˆá‹­áˆ UI áŠ¥áŠ•á‹²á‰³á‹­)
                updatePointsDisplay(currentPoints); 
                updateBalanceDisplay(currentBalance); 
                updateRankDisplay(myRank); 
                renderLeaderboard(getPlaceholderLeaderboardData());
                updateSpinDisplay(); 
                updateQuizDisplay(); 
                initializeTasksPage(); // ğŸ’¡ áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹ á‹ˆá‹²á‹«á‹áŠ‘ áŠ¥áŠ•á‹²áŒ€áˆáˆ­
            });
            
            // ğŸ’¡ Backend áŠ¥áˆµáŠªáˆ˜áŒ£ á‹µáˆ¨áˆµ á‹¨á‰¦á‰³ áˆ˜á‹«á‹£ á‹³á‰³á‹á‰½áŠ• á‹ˆá‹²á‹«á‹áŠ‘ áˆ›áˆ³á‹¨á‰µ
            updatePointsDisplay(currentPoints);
            updateSpinDisplay(); 
            updateQuizDisplay();
            initializeTasksPage(); // ğŸ’¡ áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹ á‹ˆá‹²á‹«á‹áŠ‘ áŠ¥áŠ•á‹²áŒ€áˆáˆ­
        }
        
        // ğŸ’¡ áŠ á‹²áˆµ: Placeholder Leaderboard Data
        function getPlaceholderLeaderboardData() {
             return [
                { rank: 1, name: "Abel (áŠ áŠ•á‰°)", points: 3500, type: "points" },
                { rank: 2, name: "Bethlehem", points: 3200, type: "points" },
                { rank: 3, name: "Kaleb.T", points: 2950, type: "points" },
                { rank: 4, name: "Selam.A", points: 2800, type: "points" },
                { rank: 5, name: "Yonas.M", points: 2500, type: "points" },
                { rank: 6, name: "Samson", points: 2100, type: "points" },
                { rank: 7, name: "Tigist", points: 1900, type: "points" },
                { rank: 8, name: "Bete", points: 1500, type: "points" },
                { rank: 9, name: "Kidus", points: 1200, type: "points" },
                { rank: 10, name: "Hana", points: 1000, type: "points" },
                
                // ğŸ’¡ á‹¨áŒˆá‹¢á‹á‰½ áˆáˆ³áˆŒ
                { rank: 1, name: "Selam.A", amount: 12500, type: "purchase" },
                { rank: 2, name: "Yonas.M", amount: 8100, type: "purchase" },
            ];
        }
        
        // ********** á‹¨áŒ‹áˆ« áŠ¥áŠ“ á‹¨á•áˆ®á‹á‹­áˆ á‰°áŒá‰£áˆ«á‰µ **********
        function initializeProfile() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                const username = user.username || (user.first_name + " " + (user.last_name || "")).trim();
                document.getElementById('display-username').textContent = username;
                document.getElementById('profile-initial').textContent = username.charAt(0).toUpperCase();
            }
            updatePointsDisplay(currentPoints);
            updateBalanceDisplay(currentBalance);
        }

        // ********** á‹¨áŒˆáŒ½ áˆ˜á‰€á‹¨áˆªá‹« á‰°áŒá‰£áˆ­ (Switch Page Logic) **********
        function switchPage(pageName) {
            const pages = ['shop-page', 'profile-page', 'tasks-page', 'top-page'];
            const navItems = document.querySelectorAll('#bottom-nav .nav-item');
            
            pages.forEach(id => {
                const pageElement = document.getElementById(id);
                if (pageElement) {
                    pageElement.classList.add('hidden-page');
                }
            });
            
            const selectedPageId = `${pageName}-page`;
            const selectedPageElement = document.getElementById(selectedPageId);
            if (selectedPageElement) {
                selectedPageElement.classList.remove('hidden-page');
            }

            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.onclick.toString().includes(`'${pageName}'`)) {
                    item.classList.add('active');
                }
            });

            if (pageName === 'shop') {
                updateCartDisplay();
            } else {
                tg.MainButton.hide();
            }
            
            if (pageName === 'tasks') {
                // á‹¨ Spin/Quiz áŠ­ááˆá‰½áŠ• á‹°á‰¥á‰…
                 document.getElementById('spin-game-area').style.display = 'none';
                 document.getElementById('quiz-game-area').classList.add('hidden-section');
                 document.getElementById('social-tasks-list').classList.add('hidden-section');
                 
                 initializeTasksPage(); // ğŸ’¡ áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹áŠ• áˆˆáˆ˜áŒ€áˆ˜áˆ­
            } else {
                // ğŸ’¡ áŠ¨ Tasks áŒˆáŒ½ áˆµáŠ•á‹ˆáŒ£ áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹áŠ• áˆ›áŒ¥á‹á‰µ
                clearInterval(taskTimerInterval);
            }
            
             if (pageName === 'profile') {
                initializeProfile(); 
            }
            
            // ğŸ’¡ áŠ á‹²áˆµ: Top áŒˆáŒ½ áˆ²áŠ¨áˆá‰µ á‹³á‰³á‹áŠ• áˆ›á‹˜áŒ‹áŒ€á‰µ
            if (pageName === 'top') {
                 initializeTopPage();
            }
        }
        
        // ********** á‹¨Top áŒˆáŒ½ áˆ›áˆ»áˆ»á‹« á‰°áŒá‰£áˆ«á‰µ **********
        function initializeTopPage() {
            // áŠ¨ Frontend á‰°áˆˆá‹‹á‹‹áŒ®á‰½ á‹³á‰³á‹áŠ• áˆ›áˆ³á‹¨á‰µ
            document.getElementById('top-my-rank').textContent = myRank;
            document.getElementById('top-my-balance').textContent = `${currentBalance.toFixed(2)} á‰¥áˆ­`;
            document.getElementById('top-my-points').textContent = currentPoints;
            
            // á‹¨ Leaderboard á‹³á‰³ áˆ›áˆ³á‹¨á‰µ
            renderLeaderboard(leaderboardData.length > 0 ? leaderboardData : getPlaceholderLeaderboardData());
        }
        
        /**
         * ğŸ’¡ Leaderboard á‹³á‰³áŠ• á‹¨áˆšá‹«áˆ³á‹­ á‰°áŒá‰£áˆ­
         * @param {Array} data á‹¨ Leaderboard á‹áˆ­á‹áˆ­
         */
        function renderLeaderboard(data) {
             const leaderboardDiv = document.getElementById('leaderboard-data');
             leaderboardDiv.innerHTML = '';
             
             // áŠáŒ¥á‰¥ áŠ áˆ°á‰£áˆ³á‰¢á‹á‰½ (Top Scorers)
             const pointsLeaderboard = data.filter(item => item.type === 'points').sort((a, b) => b.points - a.points);
             const pointsHeader = document.createElement('h4');
             pointsHeader.style.color = '#FFC107';
             pointsHeader.style.padding = '10px';
             pointsHeader.innerHTML = '<i class="fas fa-star"></i> áˆáˆ­áŒ¥ áŠáŒ¥á‰¥ áŠ áˆ°á‰£áˆ³á‰¢á‹á‰½';
             leaderboardDiv.appendChild(pointsHeader);
             
             pointsLeaderboard.forEach((item, index) => {
                 const div = createLeaderboardItem(index + 1, item.name, `${item.points} áŠáŒ¥á‰¥`);
                 leaderboardDiv.appendChild(div);
             });
             
             // áŒˆá‹¢á‹á‰½ (Top Buyers)
             const purchaseLeaderboard = data.filter(item => item.type === 'purchase').sort((a, b) => b.amount - a.amount);
             const purchaseHeader = document.createElement('h4');
             purchaseHeader.style.color = '#4CAF50';
             purchaseHeader.style.padding = '10px';
             purchaseHeader.innerHTML = '<i class="fas fa-shopping-cart"></i> Top áŒˆá‹¢á‹á‰½ (á‰ á‹ˆáˆ­)';
             leaderboardDiv.appendChild(purchaseHeader);
             
             purchaseLeaderboard.forEach((item, index) => {
                 const div = createLeaderboardItem(index + 1, item.name, `${item.amount.toLocaleString()} á‰¥áˆ­`);
                 leaderboardDiv.appendChild(div);
             });
        }
        
        /**
         * ğŸ’¡ áŠ áŠ•á‹µ Leaderboard Item á‹¨áˆšáˆáŒ¥áˆ­ á‰°áŒá‰£áˆ­
         */
        function createLeaderboardItem(rank, name, value) {
             const div = document.createElement('div');
             div.className = 'leaderboard-item';
             
             const rankSpan = document.createElement('span');
             rankSpan.className = 'leaderboard-rank';
             if (rank === 1) rankSpan.innerHTML = 'ğŸ¥‡';
             else if (rank === 2) rankSpan.innerHTML = 'ğŸ¥ˆ';
             else if (rank === 3) rankSpan.innerHTML = 'ğŸ¥‰';
             else rankSpan.textContent = `${rank}.`;
             div.appendChild(rankSpan);
             
             const infoDiv = document.createElement('div');
             infoDiv.className = 'leaderboard-info';
             
             const nameP = document.createElement('p');
             nameP.className = 'leaderboard-name';
             nameP.textContent = name;
             infoDiv.appendChild(nameP);
             
             div.appendChild(infoDiv);
             
             const valueSpan = document.createElement('span');
             valueSpan.className = 'leaderboard-value';
             valueSpan.textContent = value;
             div.appendChild(valueSpan);
             
             return div;
        }

        // ********** á‹¨Tasks áŒˆáŒ½ áˆ›áˆ»áˆ»á‹« á‰°áŒá‰£áˆ«á‰µ **********
        function toggleSpinGame() {
            const spinArea = document.getElementById('spin-game-area');
            const isHidden = spinArea.style.display === 'none' || spinArea.style.display === '';
            spinArea.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                initializeSpinWheel();
            }
        }
        
        function handleCouponClick() {
             handleDailyClaim();
        }
        
        function toggleTaskList(listId) {
             const list = document.getElementById(listId);
             list.classList.toggle('hidden-section');
             if (listId === 'social-tasks-list') {
                 updateTaskDisplay(socialTasksStatus);
             }
        }
        
        function toggleQuizGame() {
             const quizArea = document.getElementById('quiz-game-area');
             quizArea.classList.toggle('hidden-section');
             if (!quizArea.classList.contains('hidden-section')) {
                 updateQuizDisplay();
             }
        }

        // ********** á‹¨áŠ«á‰³áˆáŒ áˆµáŠ¥áˆ (Render Catalog Logic) **********
        function renderCatalog() {
            const catalogDiv = document.getElementById('catalog');
            catalogDiv.innerHTML = ''; 
            
            bookData.forEach(categoryData => {
                const h2 = document.createElement('h2');
                h2.textContent = categoryData.category;
                catalogDiv.appendChild(h2);
                
                const ul = document.createElement('ul');
                ul.className = 'book-list';
                ul.style.listStyle = 'none';
                ul.style.padding = '0';
                
                categoryData.items.forEach(book => {
                    const li = document.createElement('li');
                    li.style.display = 'flex'; li.style.marginBottom = '10px'; li.style.padding = '10px'; li.style.backgroundColor = 'var(--tg-theme-secondary-bg-color)'; li.style.borderRadius = '8px'; li.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    
                    const img = document.createElement('img');
                    img.className = 'book-photo';
                    img.src = book.photo_url || `https://via.placeholder.com/80x100?text=${book.id}`; 
                    img.alt = book.name;
                    img.style.width = '60px'; img.style.height = '80px'; img.style.marginRight = '10px';
                    li.appendChild(img);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.style.flexGrow = '1';
                    
                    const nameP = document.createElement('p');
                    nameP.textContent = book.name;
                    nameP.style.fontWeight = 'bold';
                    nameP.style.margin = '0 0 5px 0';
                    infoDiv.appendChild(nameP);
                    
                    const priceP = document.createElement('p');
                    priceP.textContent = `${book.price.toFixed(2)} á‰¥áˆ­`;
                    priceP.style.color = 'var(--tg-theme-link-color)';
                    priceP.style.margin = '0';
                    infoDiv.appendChild(priceP);
                    
                    li.appendChild(infoDiv);
                    
                    const addButton = document.createElement('button');
                    addButton.className = 'green-button';
                    addButton.textContent = `+ áŒ¨áˆáˆ­`; 
                    addButton.onclick = () => addToCart(book.id, book.name, book.price);
                    li.appendChild(addButton);
                    
                    ul.appendChild(li);
                });
                
                catalogDiv.appendChild(ul);
            });
        }


        // ********** á‹¨áŒ‹áˆª áŠ¥áŠ“ áŠ­áá‹« á‰°áŒá‰£áˆ«á‰µ (Shop Logic) **********
        function addToCart(itemId, itemName, itemPrice) {
            const item = cart.find(i => i.id === itemId);
            if (item) {
                item.quantity += 1; 
            } else {
                cart.push({ id: itemId, name: itemName, price: itemPrice, quantity: 1 });
            }
            totalPrice += itemPrice;
            updateCartDisplay();
        }
        
        function decreaseQuantity(itemId) {
            const itemIndex = cart.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                totalPrice = Math.max(0, totalPrice - item.price);
                item.quantity -= 1; 
                if (item.quantity <= 0) {
                    cart.splice(itemIndex, 1); 
                }
                updateCartDisplay(); 
            }
        }
        
        function updateCartDisplay() {
            const cartList = document.getElementById('cart-items');
            cartList.innerHTML = ''; 
            
            cart.forEach(item => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';

                const itemText = document.createElement('span');
                itemText.textContent = `${item.name} (${item.quantity}) - ${ (item.price * item.quantity).toFixed(2) } á‰¥áˆ­`;
                li.appendChild(itemText);
                
                const removeButton = document.createElement('button');
                removeButton.textContent = 'á‹­áˆ°áˆ¨á‹™';
                removeButton.style.backgroundColor = 'red';
                removeButton.style.border = 'none';
                removeButton.style.color = 'white';
                removeButton.style.padding = '5px 10px';
                removeButton.style.borderRadius = '8px';
                removeButton.style.marginLeft = '10px';
                removeButton.onclick = () => decreaseQuantity(item.id);
                li.appendChild(removeButton);
                
                cartList.appendChild(li);
            });
            
            document.getElementById('total-price').textContent = totalPrice.toFixed(2);
            
            if (totalPrice > 0 && !document.getElementById('shop-page').classList.contains('hidden-page')) {
                tg.MainButton.setText(`áŠ­áá‹« á‹­áˆáŒ½áˆ™: ${totalPrice.toFixed(2)} á‰¥áˆ­`).show();
                tg.MainButton.enable(); 
            } else {
                tg.MainButton.hide();
            }
        }
        
        // **** á‹¨áŠ­áá‹« áŒ¥á‹«á‰„ á‹ˆá‹° Backend á‹¨áˆšáˆ‹áŠ­á‰ á‰µ á‰°áŒá‰£áˆ­ ****
        tg.MainButton.onClick(() => {
            if (cart.length === 0) return;
            
            const user_id = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN";

            tg.MainButton.setText("áŠ­áá‹« á‰ áˆ›áˆ˜áŠ•áŒ¨á‰µ áˆ‹á‹­...").disable();
            
            const paymentDetails = {
                action: "initiate_telebirr_payment", 
                total: totalPrice.toFixed(2),
                user_id: user_id,
                cart_items: cart.map(item => ({ 
                    id: item.id, 
                    qty: item.quantity, 
                    pdf_id: bookData.flatMap(c => c.items).find(i => i.id === item.id)?.pdf_id || "PDF_MISSING"
                })),
                init_data: tg.initData // ğŸ’¡ áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ á‰°áŒ¨áˆáˆ¯áˆ
            };
            
            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentDetails)
            })
            .then(response => response.json())
            .then(data => {
                tg.MainButton.setText(`áŠ­áá‹« á‹­áˆáŒ½áˆ™: ${totalPrice.toFixed(2)} á‰¥áˆ­`).enable(); 
                tg.showAlert("á‹¨áŠ­áá‹« áŒ¥á‹«á‰„ áˆáŠ¬á‹«áˆˆáˆá¢ áŠ¥á‰£áŠ­á‹ á‰ á‰¦á‰± á‹áˆµáŒ¥ á‹¨áˆšáˆ˜áŒ£á‹áŠ• áˆ˜áˆá‹•áŠ­á‰µ á‹­áŒ á‰¥á‰á¢");
            })
            .catch(error => {
                console.error('Payment Fetch Error:', error);
                tg.showAlert("âŒ áŠ­áá‹« áˆ²áŒ á‹¨á‰… á‰½áŒáˆ­ á‰°áˆáŒ áˆ¨!");
                tg.MainButton.setText(`áŠ­áá‹« á‹­áˆáŒ½áˆ™: ${totalPrice.toFixed(2)} á‰¥áˆ­`).enable();
            });
        });
        // *************************************************************

        // ********** Spin and Win áŒŒáˆ áŠ áˆ˜áŠ­áŠ•á‹® **********
        const prizes = [
            { text: "50 áŠáŒ¥á‰¥", color: "#FFC107", value: 50 },
            { text: "100 áŠáŒ¥á‰¥", color: "#4CAF50", value: 100 },
            { text: "150 áŠáŒ¥á‰¥", color: "#2196F3", value: 150 },
            { text: "200 áŠáŒ¥á‰¥", color: "#E91E63", value: 200 },
            { text: "250 áŠáŒ¥á‰¥", color: "#9C27B0", value: 250 },
            { text: "500 áŠáŒ¥á‰¥", color: "#FF5722", value: 500 },
            { text: "á‰£á‹¶", color: "#F44336", value: 0 }, 
        ];
        
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spin-button');
        const attemptsLeftSpan = document.getElementById('attempts-left');
        const countdownSpan = document.getElementById('countdown');
        const timerDisplay = document.getElementById('timer-display');
        
        // ğŸ’¡ MAX_SPIN_ATTEMPTS áŠ¨áˆ‹á‹­ á‹ˆá‹° á‰°áˆˆá‹‹á‹‹áŒ­ á‰°á‰€á‹­áˆ¯áˆ

        function updateSpinDisplay() {
            attemptsLeftSpan.textContent = `${spinAttempts}/${MAX_SPIN_ATTEMPTS}`;
            
            if (spinAttempts > 0) {
                spinButton.disabled = false;
                spinButton.textContent = "áŠ áˆ½áŠ­áˆ­áŠ­áˆ©!";
                timerDisplay.style.display = 'none';
                clearInterval(spinTimerInterval); 
            } else {
                spinButton.disabled = true;
                spinButton.textContent = "á‹­áŒ á‰¥á‰...";

                timerDisplay.style.display = 'block'; 
                
                if (spinResetTime > 0) { 
                     startCountdown('spin', spinResetTime); // ğŸ’¡ resetTimeáŠ• á‹ˆá‹° á‹áˆµáŒ¥ áˆ›áˆˆá
                } else {
                     clearInterval(spinTimerInterval); 
                     // ğŸ’¡ áˆ›áˆµá‰°áŠ«áŠ¨á‹«: Backend áŠ«áˆáˆ˜áˆˆáˆ° á‰†áŒ£áˆªá‹ á‹œáˆ® áˆ‹á‹­ áŠ¥áŠ•á‹²á‰†á‹­
                     countdownSpan.textContent = "00:00:00"; 
                     
                     // ğŸ’¡ áŠ áŠ•á‹µ áŒŠá‹œ áˆ™áŠ¨áˆ«á‹á‰½áŠ• áŠ¥áŠ•á‹²á‹«á‹µáˆµ áŒ¥á‹«á‰„ áˆˆáˆ˜áˆ‹áŠ­ (áŠ á‹²áˆµ)
                     requestAttemptReset('spin');
                }
            }
        }
        
        // ********** Quiz Game áŠ áˆ˜áŠ­áŠ•á‹® **********
        // ğŸ’¡ MAX_QUIZ_ATTEMPTS áŠ¨áˆ‹á‹­ á‹ˆá‹° á‰°áˆˆá‹‹á‹‹áŒ­ á‰°á‰€á‹­áˆ¯áˆ
        const quizAttemptsLeftSpan = document.getElementById('quiz-attempts-left');
        const quizCountdownSpan = document.getElementById('quiz-countdown');
        const quizTimerDisplay = document.getElementById('quiz-timer-display');

        function updateQuizDisplay() {
            quizAttemptsLeftSpan.textContent = `${quizAttempts}/${MAX_QUIZ_ATTEMPTS}`;
            
            if (quizAttempts <= 0) {
                quizTimerDisplay.style.display = 'block';
                if (quizResetTime > 0) {
                    startCountdown('quiz', quizResetTime); // ğŸ’¡ resetTimeáŠ• á‹ˆá‹° á‹áˆµáŒ¥ áˆ›áˆˆá
                } else {
                    clearInterval(quizTimerInterval);
                    // ğŸ’¡ áˆ›áˆµá‰°áŠ«áŠ¨á‹«: Backend áŠ«áˆáˆ˜áˆˆáˆ° á‰†áŒ£áˆªá‹ á‹œáˆ® áˆ‹á‹­ áŠ¥áŠ•á‹²á‰†á‹­
                    quizCountdownSpan.textContent = "00:00:00";
                    
                    // ğŸ’¡ áŠ áŠ•á‹µ áŒŠá‹œ áˆ™áŠ¨áˆ«á‹á‰½áŠ• áŠ¥áŠ•á‹²á‹«á‹µáˆµ áŒ¥á‹«á‰„ áˆˆáˆ˜áˆ‹áŠ­ (áŠ á‹²áˆµ)
                    requestAttemptReset('quiz');
                }
            } else {
                quizTimerDisplay.style.display = 'none';
                clearInterval(quizTimerInterval);
            }
        }
        
        /**
         * ğŸ’¡ áˆ™áŠ¨áˆ«á‹á‰½áŠ• áˆˆáˆ›á‹°áˆµ áˆˆ Backend áŒ¥á‹«á‰„ áˆˆáˆ˜áˆ‹áŠ­
         */
        function requestAttemptReset(type) {
            const action = type === 'spin' ? "request_spin_reset" : "request_quiz_reset";
            
            // áŒ¥á‹«á‰„á‹ á‹¨áˆšáˆ‹áŠ¨á‹ áŠ áŠ•á‹µ áŒŠá‹œ á‰¥á‰» áŠá‹
            if (window[`${type}ResetRequested`]) return;
            window[`${type}ResetRequested`] = true;

             fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: action, 
                    user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN",
                    init_data: tg.initData // ğŸ’¡ áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ á‰°áŒ¨áˆáˆ¯áˆ
                })
            }).then(r => r.json()).then(processBotResponse).catch(e => console.error("Reset Fetch Error:", e));
        }
        
        /**
         * ğŸ’¡ áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹áŠ• á‹¨áˆšáŒ€áˆáˆ­ á‰°áŒá‰£áˆ­
         * @param {string} type 'spin' á‹ˆá‹­áˆ 'quiz'
         * @param {number} lastActionTime á‹¨áˆ˜áŒ¨áˆ¨áˆ»á‹ áŠ­á‹‹áŠ” á‹¨á‰°áˆáŒ¸áˆ˜á‰ á‰µ áŒŠá‹œ
         */
        function startCountdown(type, lastActionTime) {
             const timerDisplayEl = type === 'spin' ? timerDisplay : quizTimerDisplay;
             const countdownSpanEl = type === 'spin' ? countdownSpan : quizCountdownSpan;
             
             timerDisplayEl.style.display = 'block';
             
             if (type === 'spin') clearInterval(spinTimerInterval); 
             if (type === 'quiz') clearInterval(quizTimerInterval); 

             function updateTimer() {
                const now = Date.now();
                // ğŸ’¡ á‹¨24 áˆ°á‹“á‰µ á‹‘á‹°á‰± á‰ á‰µáŠ­áŠ­áˆ á‹¨áˆšá‹«á‰ á‰ƒá‰ á‰µáŠ• áŒŠá‹œ áˆ›áˆµáˆ‹á‰µ
                const nextResetTime = lastActionTime + DAILY_RESET_MS;
                let remaining = nextResetTime - now;

                if (remaining <= 0) {
                    // áˆ°á‹“á‰± á‹œáˆ® áˆ²á‹°áˆ­áˆµ á‹³á‰³á‹áŠ• áŠ¨ Backend áˆˆáˆ˜áŒ á‹¨á‰…
                    requestAttemptReset(type);

                    clearInterval(type === 'spin' ? spinTimerInterval : quizTimerInterval); 
                    
                    // áŒŠá‹œá‹ á‹œáˆ® áˆ‹á‹­ áŠ¥áŠ•á‹²á‰†áˆ áˆ›á‹µáˆ¨áŒ
                    countdownSpanEl.textContent = `00:00:00`;
                    return;
                }

                const totalSeconds = Math.floor(remaining / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                countdownSpanEl.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            if (type === 'spin') {
                spinTimerInterval = setInterval(updateTimer, 1000);
            } else {
                 quizTimerInterval = setInterval(updateTimer, 1000);
            }
            updateTimer(); 
        }
        
        function drawWheel() {
            const totalPrizes = prizes.length;
            const arcSize = (2 * Math.PI) / totalPrizes;
            const radius = canvas.width / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            prizes.forEach((prize, i) => {
                const angle = i * arcSize;
                ctx.beginPath();
                ctx.arc(radius, radius, radius, angle, angle + arcSize);
                ctx.lineTo(radius, radius);
                ctx.fillStyle = prize.color;
                ctx.fill();
                
                ctx.save();
                ctx.fillStyle = "white";
                ctx.font = "bold 12px Arial";
                ctx.translate(radius, radius);
                ctx.rotate(angle + arcSize / 2);
                ctx.textAlign = "right";
                ctx.fillText(prize.text, radius * 0.8, 5);
                ctx.restore();
            });
            
            // ğŸ’¡ áŒáˆ›á‹ áˆáˆáŒŠá‹œ áˆ˜áŒ€áˆ˜áˆªá‹« á‹ˆá‹° 0 á‹²áŒáˆª áˆ˜áˆáŒ£á‰±áŠ• á‹«áˆ¨áŒ‹áŒáŒ£áˆ
            canvas.style.transform = `rotate(0deg)`;
        }
        
        // ğŸ’¡ áŠ á‹²áˆµ á‰°áŒá‰£áˆ­: á‹¨ Spin á‹µáˆá… áˆ›áŒ«á‹ˆá‰µ
        function playSpinSound() {
            const spinSound = document.getElementById('spin-sound');
            if (spinSound) {
                // á‹µáˆáŒ¹áŠ• áŠ¨áŒ…áˆáˆ© áŠ¥áŠ•á‹²áŒ€áˆáˆ­ áŠ¥áŠ“ áŠ¥áŠ•á‹²áŒ«á‹ˆá‰µ
                spinSound.currentTime = 0; 
                spinSound.play().catch(e => console.log("Sound playback failed (Autoplay policy):", e));
            }
        }

        function spinWheel() {
             if (spinAttempts <= 0 || spinButton.disabled) {
                tg.showAlert("âš ï¸ á‰€áˆª áˆ™áŠ¨áˆ« á‹¨áˆˆá‹á‰µáˆá¢ áŠ¥á‰£áŠ­á‹ á‹­áŒ á‰¥á‰á¢");
                return;
            }
            
            // ğŸ’¡ á‹¨á‹µáˆá… áˆ›áŒ«á‹ˆá‰µ áŠ¥áŠ“ áŠ á‹áˆ«áˆ©áŠ• áˆ›áŒ¥á‹á‰µ
            playSpinSound();
            spinButton.disabled = true;
            spinButton.textContent = "á‰ áˆ›áˆ½áŠ¨áˆ­áŠ¨áˆ­ áˆ‹á‹­...";
            
             const spinData = {
                action: "spin_attempt", 
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER",
                prize_options: prizes.map(p => p.value),
                init_data: tg.initData // ğŸ’¡ áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ á‰°áŒ¨áˆáˆ¯áˆ
            };
            
            // ğŸ’¡ á‹¨áŒáˆ›á‹áŠ• áˆ½áŠ­áˆ­áŠ­áˆ­ á‹ˆá‹²á‹«á‹áŠ‘ áˆ˜áŒ€áˆ˜áˆ­
            // á‹­áˆ… á‹¨á‰¦á‰³ áˆ˜á‹«á‹£ áˆ½áŠ­áˆ­áŠ­áˆ­ áŠá‹á¢ á‰µáŠ­áŠ­áˆˆáŠ›á‹ áˆ›á‰†áˆšá‹« á‹¨áˆšáˆ˜áŒ£á‹ áŠ¨ Backend áˆáˆ‹áˆ½ á‰ áŠ‹áˆ‹ áŠá‹á¢
            canvas.style.transform = `rotate(3600deg)`; 
            
            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(spinData)
            })
            .then(r => r.json())
            .then(processBotResponse)
            .catch(e => {
                 console.error("Spin Fetch Error:", e);
                 spinButton.disabled = false;
                 spinButton.textContent = "áŠ¥áˆ½áŠ­áˆ­áŠ­áˆ©!";
                 tg.showAlert("âŒ áˆ½áŠ­áˆ­áŠ­áˆªá‰µ áˆ²áŒ á‹¨á‰… á‰½áŒáˆ­ á‰°áˆáŒ áˆ¨!");
                 // á‰½áŒáˆ­ áˆ²áˆáŒ áˆ­ áŒáˆ›á‹ á‹ˆá‹° á‹œáˆ® áŠ¥áŠ•á‹²áˆ˜áˆˆáˆµ
                 canvas.style.transform = `rotate(0deg)`; 
            });
             
             
        }
        
        function initializeSpinWheel() {
            drawWheel();
            updateSpinDisplay();
            spinButton.onclick = spinWheel;
        }
        
        function updatePointsDisplay(newPoints) {
            currentPoints = newPoints;
            document.getElementById('user-points').textContent = currentPoints;
            document.getElementById('top-my-points').textContent = currentPoints; // ğŸ’¡ áˆˆ Top áŒˆáŒ½
        }
        
        function updateBalanceDisplay(newBalance) {
             currentBalance = newBalance;
             // á‹¨á•áˆ®á‹á‹­áˆ áŒˆáŒ½ áˆ›áˆ»áˆ»á‹« (á‰ áˆ˜áŒ€áˆ˜áˆªá‹«á‹ áŠ®á‹µ áˆ‹á‹­ 0.00 á‰¥áˆ­ á‰¥á‰» áˆµáˆˆáŠá‰ áˆ¨)
             const balanceItem = document.querySelector('#profile-page .info-card .info-item:nth-child(1) .item-value');
             if (balanceItem) {
                 balanceItem.textContent = `${currentBalance.toFixed(2)} á‰¥áˆ­`;
             }
             document.getElementById('top-my-balance').textContent = `${currentBalance.toFixed(2)} á‰¥áˆ­`; // ğŸ’¡ áˆˆ Top áŒˆáŒ½
        }
        
        function updateRankDisplay(newRank) {
             myRank = newRank;
             document.getElementById('top-my-rank').textContent = myRank; // ğŸ’¡ áˆˆ Top áŒˆáŒ½
        }

        // ********** á‹¨áˆ›áˆ…á‰ áˆ«á‹Š Tasks áŠ áˆ˜áŠ­áŠ•á‹® **********
        function updateTaskDisplay(tasksStatus) {
            socialTasksStatus = tasksStatus; 
            for (const taskId in tasksStatus) {
                const taskElementId = `task-${taskId.toLowerCase().replace('_', '-')}`;
                const item = document.getElementById(taskElementId);
                const button = item ? item.querySelector('.task-button') : null;
                const originalText = button ? (taskId === 'YT_SUB' ? 'áˆ°á‰¥áˆµáŠ­áˆ«á‹­á‰¥' : 'á‰°á‰€áˆ‹á‰€áˆ!') : '';

                if (tasksStatus[taskId].completed) {
                    if (button) {
                        button.textContent = "á‰°áŒ áŠ“á‰‹áˆ âœ”ï¸";
                        button.disabled = true;
                        button.style.backgroundColor = '#6c757d'; 
                    }
                } else if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = '#28a745';
                }
            }
        }
        
        function handleTaskClick(taskId, url) {
            if (socialTasksStatus[taskId] && socialTasksStatus[taskId].completed) {
                tg.showAlert("á‹­áˆ…áŠ• á‰°áŒá‰£áˆ­ áŠ áˆµá‰€á‹µáˆ˜á‹ áŠ áŒ áŠ“á‰€á‹‹áˆ!");
                return;
            }

            tg.openLink(url);
            
            tg.showConfirm(
                "á‰»áŠ“áˆ‰áŠ• áŠ¨á‰°á‰€áˆ‹á‰€áˆ‰/áˆ°á‰¥áˆµáŠ­áˆ«á‹­á‰¥ áŠ«á‹°áˆ¨áŒ‰ á‰ áŠ‹áˆ‹ 'áŠ¥áˆ­áŒáŒ áŠ› áŠáŠ' á‹¨áˆšáˆˆá‹áŠ• á‹­áŒ«áŠ‘á¢", 
                (isConfirmed) => {
                    if (isConfirmed) {
                        const button = document.querySelector(`[data-task-id="${taskId}"]`);
                        
                        const verificationData = {
                            action: "verify_social_task",
                            task_id: taskId,
                            user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER",
                            init_data: tg.initData // ğŸ’¡ áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ á‰°áŒ¨áˆáˆ¯áˆ
                        };
                        
                         fetch(NETLIFY_FUNCTION_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(verificationData)
                        })
                        .then(r => r.json())
                        .then(processBotResponse)
                        .catch(e => {
                            console.error("Task Verification Fetch Error:", e);
                            tg.showAlert("âŒ Task áˆ²áˆ¨áŒ‹áŒˆáŒ¥ á‰½áŒáˆ­ á‰°áˆáŒ áˆ¨!");
                        });
                        
                        tg.showAlert("áŒ¥á‹«á‰„á‹ á‰°áˆáŠ³áˆá¢ á‰µáŠ­áŠ­áˆˆáŠ›áŠá‰µá‹áŠ• áŠ¥áˆµáŠªá‹«áˆ¨áŒ‹áŒáŒ¥ á‹­áŒ á‰¥á‰!");

                        if (button) {
                            button.disabled = true;
                            button.textContent = "á‰ áˆ›áˆ¨áŒ‹áŒˆáŒ¥ áˆ‹á‹­...";
                            button.style.backgroundColor = '#ffc107'; 
                        }

                    } else {
                        tg.showAlert("áŠ¥áˆ­áŒáŒ áŠ› áŠáŠ áˆ³á‹­áŒ«áŠ‘ áŠ¨á‹ˆáŒ¡ áˆ›áˆ¨áŒ‹áŒˆáŒ«á‹ áŠ á‹­áˆ°áˆ«áˆ!");
                    }
                }
            );
        }

        // ********** á‹•áˆˆá‰³á‹Š áŒ‰áˆ­áˆ» áŠ á‹«á‹«á‹ **********
        function handleDailyClaim() {
            const now = Date.now();
            const timeElapsed = now - dailyClaimTime;
            
            // ğŸ’¡ á‹•áˆˆá‰³á‹Š á‹¨áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹áŠ• áˆˆáˆ˜áŒ á‰€áˆ á‰°áˆµá‰°áŠ«áŠ­áˆáˆ
            const nextClaimTime = dailyClaimTime + DAILY_RESET_MS;
            if (now < nextClaimTime) {
                 // á‹¨24 áˆ°á‹“á‰µ á‰€áˆª áŒŠá‹œáŠ• áˆˆáˆ›áˆ³á‹¨á‰µ
                 const totalRemainingSeconds = Math.floor((nextClaimTime - now) / 1000);
                 const hours = Math.floor(totalRemainingSeconds / 3600);
                 const minutes = Math.floor((totalRemainingSeconds % 3600) / 60);
                 const seconds = totalRemainingSeconds % 60;
                 
                 tg.showAlert(`âš ï¸ á‹¨á‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µá‹áŠ• áŠ áˆµá‰€á‹µáˆ˜á‹ á‹ˆáˆµá‹°á‹‹áˆá¢ á‰€áˆª áŒŠá‹œ: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                 return;
            }
            
            const couponButton = document.getElementById('coupon-btn');
            couponButton.disabled = true;
            couponButton.textContent = "á‰ áˆ›áˆµáˆá€áˆ áˆ‹á‹­...";
            couponButton.style.backgroundColor = '#ffc107'; 
            
            const claimData = {
                action: "claim_daily_bonus", 
                user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER",
                init_data: tg.initData // ğŸ’¡ áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ á‰°áŒ¨áˆáˆ¯áˆ
            };
            
            fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(claimData)
            })
            .then(r => r.json())
            .then(processBotResponse)
            .catch(e => {
                console.error("Daily Claim Fetch Error:", e);
                tg.showAlert("âŒ áŒ‰áˆ­áˆ» áˆ²áŒ á‹¨á‰… á‰½áŒáˆ­ á‰°áˆáŒ áˆ¨!");
                couponButton.disabled = false;
                couponButton.textContent = "Coupon";
                couponButton.style.backgroundColor = '#6f42c1'; 
            });
        }


        // ********** á‰  Tasks áŒˆáŒ½ áˆ‹á‹­ á‹«áˆ‰ áŠ­ááˆá‰½áŠ• áˆ˜á‰€á‹«á‹¨áˆ­ **********
        
        /**
         * ğŸ’¡ á‹‹áŠ“á‹ áˆ°á‹“á‰µ á‰†áŒ£áˆª á‰°áŒá‰£áˆ­: áŠ¨áˆ¦áˆµá‰± á‹¨áˆ˜áŒ¨áˆ¨áˆ» áŒŠá‹œá‹«á‰µ á‰°áŠáˆµá‰¶ á‹¨áˆšá‰€áŒ¥áˆˆá‹áŠ• 24 áˆ°á‹“á‰µ áˆªáˆ´á‰µ áŒŠá‹œ á‹«áˆ³á‹«áˆ
         * @param {number} lastActionTime á‹¨áˆ˜áŒ¨áˆ¨áˆ»á‹ á‹•áˆˆá‰³á‹Š áŠ­á‹‹áŠ” á‹¨á‰°áˆáŒ¸áˆ˜á‰ á‰µ áŒŠá‹œ (Timestamp)
         */
        function updateMainTimerDisplay() {
             // ğŸ’¡ Backend áŠ¥áˆµáŠªáˆ˜áˆˆáˆµ á‹µáˆ¨áˆµ á‰¢á‹«áŠ•áˆµ 24 áˆ°á‹“á‰µ áˆˆáˆ˜áŒ á‰ á‰… á‹¨áˆšá‹«áˆµá‰½áˆ á‹¨á‰¦á‰³ áˆ˜á‹«á‹£ áŠ¥áˆ´á‰µ
             const placeholderTime = Date.now() - (DAILY_RESET_MS / 2); // áŠ áˆáŠ• áŠ«áˆˆá‰ á‰µ áŒáˆ›áˆ½ á‰€áŠ• á‰ áŠá‰µ
             
             // ğŸ’¡ 0 áŠ¨áˆ†áŠ (áˆ˜áŒ€áˆ˜áˆªá‹« áˆ‹á‹­) á‹¨á‰¦á‰³ áˆ˜á‹«á‹£á‹áŠ• áˆ˜áŒ á‰€áˆ
             const lastOpTime = Math.max(dailyClaimTime, spinResetTime, quizResetTime);
             const lastOperationTime = lastOpTime > 0 ? lastOpTime : placeholderTime;
             
             if (lastOperationTime === 0) {
                 // ğŸ’¡ á‹³á‰³ áŒˆáŠ“ áŠ«áˆá‰°áŒ«áŠ áˆ›áˆ³á‹«á‹áŠ• 00:00:00 áˆ‹á‹­ á‹«á‹°áˆ­áŒ‹áˆ
                 document.getElementById('timer-hours').textContent = '00';
                 document.getElementById('timer-minutes').textContent = '00';
                 document.getElementById('timer-seconds').textContent = '00';
                 return;
            }
            
            const now = Date.now();
            
            // ğŸ’¡ á‹¨24 áˆ°á‹“á‰µ á‹‘á‹°á‰± á‰ á‰µáŠ­áŠ­áˆ á‹¨áˆšá‹«á‰ á‰ƒá‰ á‰µáŠ• áŒŠá‹œ áˆ›áˆµáˆ‹á‰µ
            const nextResetTime = lastOperationTime + DAILY_RESET_MS;
            let remaining = nextResetTime - now;
            
            if (remaining <= 0) {
                 // ğŸ’¡ áˆªáˆ´á‰µ á‹¨áˆšáŒ á‹­á‰… áŒŠá‹œ áŠ¨á‹°áˆ¨áˆ° á‰ áŠ‹áˆ‹ á‰†áŒ£áˆªá‹áŠ• 00:00:00 áˆ‹á‹­ áˆ›á‹µáˆ¨áŒ
                 document.getElementById('timer-hours').textContent = '00';
                 document.getElementById('timer-minutes').textContent = '00';
                 document.getElementById('timer-seconds').textContent = '00';
                 return;
            }

            const totalSeconds = Math.floor(remaining / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            document.getElementById('timer-hours').textContent = String(hours).padStart(2, '0');
            document.getElementById('timer-minutes').textContent = String(minutes).padStart(2, '0');
            document.getElementById('timer-seconds').textContent = String(seconds).padStart(2, '0');
        }
        
        /**
         * ğŸ’¡ á‹¨ Tasks áŒˆáŒ½áŠ• áˆ²áŠ¨áˆá‰µ áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹áŠ• áˆˆáˆ˜áŒ€áˆ˜áˆ­
         */
        function initializeTasksPage() {
             updateTaskDisplay(socialTasksStatus);
             
             clearInterval(taskTimerInterval);
             taskTimerInterval = setInterval(updateMainTimerDisplay, 1000);
             updateMainTimerDisplay();
        }
        
        // ************************************************************************


        // ********** áŠ¨á‰¦á‰± á‹¨áˆšáˆ˜áŒ£á‹áŠ• áˆáˆ‹áˆ½ á‹¨áˆšá‰†áŒ£áŒ áˆ­ á‹‹áŠ“ á‰°áŒá‰£áˆ­ **********
        function processBotResponse(data) {
            
            // 1. á‹¨áŒˆáŒ½ áˆ›áˆµáŒ€áˆ˜áˆ­á‹« á‹³á‰³
            if (data.action === "initial_data") {
                updatePointsDisplay(data.points || 0);
                updateBalanceDisplay(data.balance || 0.00); // ğŸ’¡ áŠ á‹²áˆµ: Balance
                updateRankDisplay(data.rank || 999); // ğŸ’¡ áŠ á‹²áˆµ: Rank
                leaderboardData = data.leaderboard_data || []; // ğŸ’¡ áŠ á‹²áˆµ: Leaderboard á‹³á‰³
                
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    const username = user.username || (user.first_name + " " + (user.last_name || "")).trim();
                    document.getElementById('display-username').textContent = username;
                    document.getElementById('profile-initial').textContent = username.charAt(0).toUpperCase();
                }
                
                // ğŸ’¡ áŠ¨Backend á‹¨áˆ˜áŒ¡á‰µ áŠ¥áˆ´á‰¶á‰½
                spinAttempts = data.spin_data.attempts || MAX_SPIN_ATTEMPTS; 
                spinResetTime = data.spin_data.last_spin || 0;
                
                quizAttempts = data.quiz_data.attempts || MAX_QUIZ_ATTEMPTS;
                quizResetTime = data.quiz_data.last_quiz || 0;
                
                updateTaskDisplay(data.tasks_status || {}); 
                
                if (data.daily_bonus) {
                     dailyClaimTime = data.daily_bonus.last_claim || 0; 
                }

                updateSpinDisplay();
                updateQuizDisplay(); 
                initializeTasksPage(); 
                
            }
            
            // 2. á‹¨áˆ›áˆ…á‰ áˆ«á‹Š Tasks áˆ›áˆ¨áŒ‹áŒˆáŒ« áˆáˆ‹áˆ½
            else if (data.action === "task_verified" && data.task_id) {
                 const button = document.querySelector(`[data-task-id="${data.task_id}"]`);
                 const originalText = button.dataset.taskText || (data.task_id === 'YT_SUB' ? 'áˆ°á‰¥áˆµáŠ­áˆ«á‹­á‰¥' : 'á‰°á‰€áˆ‹á‰€áˆ!');

                if (data.success) {
                    updatePointsDisplay(data.new_points || currentPoints); 
                    
                    if (socialTasksStatus[data.task_id]) {
                        socialTasksStatus[data.task_id].completed = true;
                    }
                    updateTaskDisplay(socialTasksStatus); 
                    tg.showAlert(`âœ… Task á‰°áŒ áŠ“á‰‹áˆ! ${data.points_gained || 0} áŠáŒ¥á‰¥ áŒˆá‰¥á‰¶áˆá‹á‰³áˆ!`);
                } else {
                    tg.showAlert("âš ï¸ áˆ›áˆ¨áŒ‹áŒˆáŒ«á‹ áŠ áˆá‰°áˆ³áŠ«áˆá¢ á‰»áŠ“áˆ‰áŠ•/áŒáˆ©á‘áŠ• á‰ á‰µáŠ­áŠ­áˆ á‰°á‰€áˆ‹á‰…áˆˆá‹‹áˆ?!");
                    
                    if (button) {
                         button.disabled = false;
                         button.textContent = originalText;
                         button.style.backgroundColor = '#28a745';
                    }
                }
            } 
            
            // 3. á‹¨Spin Wheel áˆáˆ‹áˆ½ (Backend á‹áŒ¤á‰±áŠ• áˆ²á‹ˆáˆµáŠ•)
            else if (data.action === "spin_result") {
                const wonPrizeValue = data.points_won;
                
                // ğŸ’¡ áŠ áˆáŠ• áŠ áˆ¸áŠ“áŠá‹áŠ• áŠ¢áŠ•á‹´áŠ­áˆµ áŠ¨Backend á‰°á‰€á‰¥áˆˆáŠ• á‰ á‰µáŠ­áŠ­áˆˆáŠ›á‹ á‰¦á‰³ áˆ‹á‹­ áŠ¥áŠ“á‰†áˆ›áˆˆáŠ•
                const winningIndex = prizes.findIndex(p => p.value === wonPrizeValue);
                const totalPrizes = prizes.length;
                const arcSize = 360 / totalPrizes;
                
                // ğŸ’¡ á‰µáŠ­áŠ­áˆˆáŠ›á‹áŠ• á‹¨áˆ›á‰†áˆšá‹« áŠ áŠ•áŒáˆ áˆ›áˆµáˆ‹á‰µ
                // 3600deg (10 áˆ™áˆ‰ áˆ½áŠ­áˆ­áŠ­áˆ®á‰½) + áŠ¨áˆ›á‰†áˆšá‹« á‰¦á‰³ á‰µáŠ•áˆ½ á‹ˆá‹° áŠ‹áˆ‹ (á‰ áˆ›á‹áˆ­ á‹áˆµáŒ¥ áˆˆáˆ˜á‰†áˆ)
                const stopAngle = 3600 + (360 - (winningIndex * arcSize) - (arcSize / 2));
                
                 canvas.style.transform = `rotate(${stopAngle}deg)`;
                 
                 // ğŸ’¡ á‹µáˆááŠ• áˆ›áŒ¥á‹á‰µ
                 document.getElementById('spin-sound').pause();
                 
                 setTimeout(() => {
                    updatePointsDisplay(data.new_points || currentPoints); 
                    spinAttempts = data.attempts_left || 0; 
                    spinResetTime = data.last_spin || 0; 
                    
                    const wonPrize = prizes.find(p => p.value === wonPrizeValue);
                    const prizeText = wonPrize ? wonPrize.text : `${wonPrizeValue} áŠáŒ¥á‰¥`;

                    if (wonPrizeValue > 0) {
                        tg.showAlert(`ğŸ‰ áŠ¥áŠ•áŠ³áŠ• á‹°áˆµ áŠ áˆˆáˆ…! ${prizeText} áŠ áˆ¸áŠ•áˆá‹‹áˆ!`);
                    } else {
                        tg.showAlert(`ğŸ˜” ${prizeText} áŠ áŒ‹áŒ¥áˆáˆƒáˆá¢ áˆˆáˆšá‰€áŒ¥áˆˆá‹ áŒŠá‹œ áˆáŠ­áˆ­!`);
                    }
                    
                    spinButton.disabled = false;
                    
                    updateSpinDisplay(); 
                    initializeTasksPage(); 
                    
                    // ğŸ’¡ áŒáˆ›á‹áŠ• á‹ˆá‹° á‹œáˆ® á‹²áŒáˆª á‰ áˆ˜áˆ˜áˆˆáˆµ áˆˆáˆšá‰€áŒ¥áˆˆá‹ áˆ½áŠ­áˆ­áŠ­áˆ­ áˆ›á‹˜áŒ‹áŒ€á‰µ
                    setTimeout(() => {
                         canvas.style.transform = `rotate(0deg)`;
                    }, 500); 
                    
                 }, 5500); // ğŸ’¡ áŠ áŠ’áˆœáˆ½áŠ‘ áŠ«áˆˆá‰€ á‰ áŠ‹áˆ‹
                 
            }
            
            // 4. á‹¨áŠ­áá‹« áˆ›áˆ¨áŒ‹áŒˆáŒ« áˆáˆ‹áˆ½
            else if (data.action === "payment_confirmed") {
                if (data.success) {
                    tg.showAlert(`ğŸ‰ áŠ­áá‹«á‹ á‰°áˆ³áŠ­á‰·áˆ! ${data.amount} á‰¥áˆ­ á‰°á‰€á‰¥áˆˆáŠ“áˆá¢ áˆ˜áŒ½áˆáá‹ áˆŠáˆˆá‰€á‰… áŠá‹!`);
                    cart = [];
                    totalPrice = 0;
                    updateCartDisplay();
                    tg.MainButton.setText(`áŠ­áá‹« á‹­áˆáŒ½áˆ™: 0.00 á‰¥áˆ­`).hide();
                } else {
                    tg.showAlert("âŒ áŠ­áá‹«á‹ áŠ áˆá‰°áˆ³áŠ«áˆá¢ áŠ¥á‰£áŠ­á‹ áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©á¢");
                    updateCartDisplay(); 
                }
            }
             // 5. áˆ™áŠ¨áˆ«á‹á‰½ áŠ¨24 áˆ°á‹“á‰µ á‰ áŠ‹áˆ‹ áˆ²á‹«á‹µáˆ±
            else if (data.action === "attempts_refreshed") {
                if (data.type === 'spin') {
                     spinAttempts = data.attempts || MAX_SPIN_ATTEMPTS; 
                     spinResetTime = data.last_spin || 0;
                     updateSpinDisplay();
                     tg.showAlert("âœ… á‹¨ Spin áˆ™áŠ¨áˆ«á‹á‰½á‹ á‰³á‹µáˆ°á‹‹áˆ!");
                } else if (data.type === 'quiz') {
                     quizAttempts = data.attempts || MAX_QUIZ_ATTEMPTS; 
                     quizResetTime = data.last_quiz || 0;
                     updateQuizDisplay();
                     tg.showAlert("âœ… á‹¨ Quiz áˆ™áŠ¨áˆ«á‹á‰½á‹ á‰³á‹µáˆ°á‹‹áˆ!");
                }
                
                // ğŸ’¡ áŒ¥á‹«á‰„ áŠ¨á‰°áˆ˜áˆˆáˆ° á‰ áŠ‹áˆ‹ á‹³áŒáˆ áŠ¥áŠ•á‹³á‹­áŒ á‹­á‰…
                if (data.type === 'spin') window.spinResetRequested = false;
                if (data.type === 'quiz') window.quizResetRequested = false;
                
                initializeTasksPage(); 
            }
            
            // 6. á‹•áˆˆá‰³á‹Š áŒ‰áˆ­áˆ»
            else if (data.action === "daily_bonus_claimed") {
                const couponButton = document.getElementById('coupon-btn');
                if (data.success) {
                    updatePointsDisplay(data.new_points || currentPoints);
                    dailyClaimTime = data.last_claim || Date.now(); 
                    
                    tg.showAlert(`ğŸ‰ áŠ¥áŠ•áŠ³áŠ• á‹°áˆµ áŠ áˆˆáˆ…! á‹¨á‹•áˆˆá‰± 500 áŠáŒ¥á‰¥ áŒˆá‰¥á‰¶áˆá‹á‰³áˆ!`);
                    
                    couponButton.disabled = true;
                    couponButton.textContent = "âœ” á‹•áˆˆá‰³á‹Š";
                    couponButton.style.backgroundColor = '#6c757d';
                } else {
                    tg.showAlert("âŒ á‹¨á‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µ áŒ¥á‹«á‰„á‹ áŠ áˆá‰°áˆ³áŠ«áˆá¢ (áˆáŠ“áˆá‰£á‰µ áŠ áˆµá‰€á‹µáˆ˜á‹ á‹ˆáˆµá‹°á‹‹áˆ?)");
                    couponButton.disabled = false;
                    couponButton.textContent = "Coupon";
                    couponButton.style.backgroundColor = '#6f42c1'; 
                }
                
                initializeTasksPage(); 
            }
            
            // 7. áˆŒáˆá‰½ á‹¨áŠáŒ¥á‰¥ áˆ˜áŒ¨áˆ˜áˆ­ áˆáˆ‹áˆ¾á‰½ (áˆˆáˆáˆ³áˆŒ áŠ¨Quiz)
            else if (data.action === "points_added") {
                updatePointsDisplay(data.new_points || currentPoints); 
                if (data.type === 'quiz') {
                    quizAttempts = data.attempts_left || 0;
                    quizResetTime = data.last_quiz || 0;
                    updateQuizDisplay();
                    initializeTasksPage();
                }
            }
        }

        // á‹¨á‰¦á‰µ áˆáˆ‹áˆ½ á‹¨áˆšá‰€á‰ áˆˆá‹ á‹‹áŠ“ á‰°áŒá‰£áˆ­ (á‹­áˆ… á‹¨áˆšáˆ°áˆ«á‹ Botá‹ web_app_data áˆ²áˆ˜áˆáˆµ á‰¥á‰» áŠá‹)
        tg.onEvent('web_app_data', (event) => {
            try {
                const data = JSON.parse(event.data);
                processBotResponse(data);
            } catch (e) {
                console.error("Error processing web_app_data:", e);
                tg.showAlert("áŠ¨á‰¦á‰± áˆ˜áˆáˆµ áˆ²á‰€á‰ áˆ á‰½áŒáˆ­ á‰°áˆáŒ¥áˆ¯áˆ! (áŠ®áŠ•áˆ¶áˆ á‹­áˆ˜áˆáŠ¨á‰±)");
                if(spinButton) { 
                   spinButton.disabled = false; 
                   spinButton.textContent = "áŠ¥áˆ½áŠ­áˆ­áŠ­áˆ©!";
                }
                updateCartDisplay(); 
            }
        });


        
        // áˆ˜á‰°áŒá‰ áˆªá‹«á‹ áˆ²áŒ€áˆáˆ­ á‹¨áˆšáŒ áˆ© á‰°áŒá‰£áˆ«á‰µ
        renderCatalog();
        loadInitialData(); 
        
        switchPage('shop'); 

    </script>
</body>
</html>

