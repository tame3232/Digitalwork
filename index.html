<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School ·àã·ã≠·â•·à®·à™ Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* ... (·ã®·âÄ·ã∞·àò·ãç CSS ·äÆ·ãµ ·ä•·ãö·àÖ ·ã≠·åà·â£·àç) ... */
        /* ·â†·â•·ãõ·âµ ·ã®CSS ·ä≠·çç·àâ ·à≥·ã≠·âÄ·ã®·à≠ ·àà·âµ·åç·â†·à´ ·â∞·ã∞·à´·àΩ·äê·âµ ·ã≠·âÜ·ã´·àç */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            padding-bottom: 70px; 
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #333);
            transition: background-color 0.3s, color 0.3s;
        }
        h1, h2, h3 {
            color: var(--tg-theme-link-color, #007bff);
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .hidden-page, .hidden-section {
            display: none !important;
        }
        .info-card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            margin: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-bg-color, #eee);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .green-button, .red-button, .action-button, .task-button {
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s, opacity 0.3s;
        }
        .green-button {
            background-color: #28a745;
            color: white;
        }
        .red-button { 
            background-color: #dc3545;
            color: white;
            width: 100%;
            padding: 10px 15px;
        }
        .action-button {
            margin-left: auto; 
            background-color: #FFC107;
            color: #333;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }
        .timer-container {
            display: flex;
            justify-content: center;
            padding: 15px 0;
            font-size: 2em;
            font-weight: bold;
        }
        .time-segment {
            background-color: var(--tg-theme-secondary-bg-color, #333); 
            color: var(--tg-theme-link-color, #FFC107);
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 5px;
        }
        .main-task-buttons {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
        }
        .task-action-button {
            width: 30%;
            height: 100px;
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        #contest-btn { background-color: #FFC107; color: #333; } 
        #spin-btn { background-color: #28a745; }
        #coupon-btn { background-color: #6f42c1; }
        .reward-section { margin: 15px; }
        #road-icon { background-color: #dc3545; } 
        #quiz-icon { background-color: #6f42c1; } 
        #wheelCanvas {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); 
            background-color: var(--tg-theme-bg-color, #eee);
            border-radius: 50%;
        }
        .spin-container {
             display: none; 
             text-align: center;
             padding: 20px;
             background-color: var(--tg-theme-secondary-bg-color, #ffffff);
             border-radius: 10px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
             margin-top: 15px;
        }
        #bottom-nav {
            position: fixed; 
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex; 
            justify-content: space-around; 
            padding: 5px 0 10px 0; 
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-bg-color, #eee);
            z-index: 100; 
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05); 
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #999);
            font-size: 0.8em;
            padding: 5px;
            user-select: none;
        }
        .nav-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            margin-bottom: 2px;
        }
        .nav-item.active {
            color: var(--tg-theme-link-color, #007bff); 
        }
        .nav-item.active .nav-icon {
            background-color: var(--tg-theme-link-color, #007bff); 
        }
        .nav-item.active i {
            color: var(--tg-theme-secondary-bg-color, #ffffff); 
        }
        #toast-container {
            position: fixed;
            bottom: 70px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .toast {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-weight: 500;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>

    <audio id="spin-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" preload="auto"></audio> 
    
    <div id="toast-container"></div>

    <div id="shop-page">
        <div id="cart-container" class="info-card">
            <h2>üõí ·ã®·à±·âÖ ·àõ·ãï·ä®·àç</h2>
            <ul id="cart-items" style="list-style: none; padding: 0;"></ul>
            <h3>·å†·âÖ·àã·àã ·ãµ·àù·à≠: <span id="total-price">0.00</span> ·â•·à≠</h3>
        </div>
        <div id="catalog"></div>
    </div>
    
    <div id="profile-page" class="hidden-page" style="margin: -10px; padding: 0;">
        <div class="info-card" style="text-align: center;">
            <div class="profile-icon" id="profile-initial" style="width: 60px; height: 60px; line-height: 60px; font-size: 2em; margin: 0 auto 10px; background-color: #6f42c1; color: white; border-radius: 50%;">?</div>
            <p class="profile-username" id="display-username" style="font-weight: bold; font-size: 1.2em; margin: 0;">Loading...</p>
        </div>

        <div class="info-card">
            <div class="info-item">
                <span class="item-label"><i class="fas fa-dollar-sign"></i> ·âÄ·à™ ·àÇ·à≥·â• (Balance)</span>
                <span class="item-value">0.00 ·â•·à≠</span> 
                <button class="green-button" onclick="showToast('·åà·äï·ãò·â• ·àõ·ãç·å£·âµ ·â∞·åç·â£·à≠ ·â†·â¶·â± ·àò·ã∞·åà·çç ·ä†·àà·â†·âµ·ç¢');">Withdraw</button>
            </div>
            <div class="info-item">
                <span class="item-label"><i class="fas fa-star"></i> ·àΩ·àç·àõ·âµ</span>
                <span class="item-value" id="user-points">0</span> </div>
             <div class="info-item">
                <span class="item-label"><i class="fas fa-ticket-alt"></i> Tickets</span>
                <span class="item-value">0</span>
            </div>
        </div>
        
         <div class="info-card">
             <div class="info-item">
                <span class="item-label"><i class="fas fa-wallet"></i> ·ä≠·çç·ã´</span>
                <button class="green-button" onclick="showToast('·ã®·ä≠·çç·ã´ ·ãò·ã¥ ·âÖ·äï·â•·àÆ·âΩ');">·ã®·ä≠·çç·ã´ ·ãò·ã¥ ></button> 
            </div>
            
            <div class="info-item">
                <span class="item-label"><i class="fas fa-sync-alt"></i> ·äê·å•·â• ·ãà·ã∞ ·â•·à≠ ·âÄ·ã≠·à≠</span>
                <button class="green-button" onclick="showToast('·â†·âÖ·à≠·â• ·âÄ·äï ·ã≠·å†·â•·âÅ...');" style="background-color: #f0ad4e;">
                    Exchange
                </button> 
            </div>
            
            <div class="info-item">
                <span class="item-label"><i class="fas fa-globe"></i> ·âã·äï·âã</span>
                <span class="item-value">·ä†·àõ·à≠·äõ <i class="fas fa-chevron-down"></i></span>
            </div>
        </div>

        <div class="info-card">
            <button class="red-button" onclick="tg.close();">·ãù·åã</button>
        </div>
    </div>
    
    <div id="tasks-page" class="hidden-page" style="margin: -10px; padding: 0;">
        
        <div class="timer-container">
            <div class="time-segment" id="timer-hours">00</div>
            :
            <div class="time-segment" id="timer-minutes">00</div>
            :
            <div class="time-segment" id="timer-seconds">00</div>
        </div>

        <div class="main-task-buttons">
            <button id="contest-btn" class="task-action-button" onclick="showToast('·â†·âÖ·à≠·â• ·âÄ·äï ·ã≠·å†·â•·âÅ...');">
                <span class="daily-label" style="position: absolute; top: 5px; left: 5px; background-color: #dc3545; color: white; padding: 2px 5px; border-radius: 5px; font-size: 0.7em;">Daily</span>
                <i class="fas fa-trophy"></i>
                Contest
            </button>

            <button id="spin-btn" class="task-action-button" onclick="toggleSpinGame();">
                <i class="fas fa-gem"></i>
                Spin
            </button>

            <button id="coupon-btn" class="task-action-button" onclick="handleDailyClaim();">
                <i class="fas fa-gift"></i>
                Coupon
            </button>
        </div>
        
        <div id="spin-game-area" class="spin-container">
            <h3>üéÅ ·ã®·ãõ·à¨ ·ãï·ãµ·àç·ãé! (Spin & Win)</h3>
            <div style="position: relative; width: 300px; height: 300px; margin: 20px auto;">
                <canvas id="wheelCanvas" width="300" height="300"></canvas>
                <div id="pointer" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #dc3545;"></div>
            </div>
            <button id="spin-button" class="green-button" style="padding: 15px 30px; font-size: 1.2em; width: 80%;">
                ·ä•·àΩ·ä≠·à≠·ä≠·à©!
            </button>
            <p style="margin-top: 15px;">·âÄ·à™ ·àô·ä®·à´·ãé·âΩ: <span id="attempts-left">...</span>/5</p>
            <p id="timer-display" style="color: #dc3545; font-weight: bold; margin-top: 10px; display: none;">
                ·ãµ·åã·àö ·àà·àò·å´·ãà·âµ: <span id="countdown">...</span>
            </p>
        </div>


        <h3 style="padding-left: 15px; margin-top: 30px; color: var(--tg-theme-text-color);"> ·äê·å•·â• ·àõ·åç·äõ</h3>
        
        <div id="telegram-community-section" class="reward-section info-card">
            <div class="reward-item" onclick="toggleTaskList('social-tasks-list');" style="cursor: pointer;">
                <div id="road-icon" class="reward-icon" style="width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: white; font-weight: bold;">ROA<br>D</div>
                <div class="reward-info">
                    <h4 style="margin: 0 0 2px 0; color: var(--tg-theme-text-color);">·â¥·àå·åç·à´·àù Community</h4>
                    <p style="margin: 0; font-size: 0.9em; color: var(--tg-theme-hint-color);">·âª·äì·àç ·â†·àò·âÄ·àã·âÄ·àç ·äê·å•·â• ·ã´·åç·äô</p>
                </div>
                <button class="action-button">·ã≠·ä≠·çà·â±</button>
            </div>
             <ul id="social-tasks-list" class="task-list hidden-section" style="padding: 10px 0; list-style: none;">
                 <div class="info-item" id="task-tg-ch">
                    <span class="item-label">
                        <i class="fab fa-telegram-plane" style="color: #0088cc; margin-right: 5px;"></i> 
                        **·â¥·àå·åç·à´·àù ·âª·äì·àç ·â∞·âÄ·àã·âÄ·àç**
                    </span>
                    <span class="item-value">+150 ·äê·å•·â•</span>
                    <button class="green-button task-button" 
                            data-task-id="TG_CH" 
                            data-points="150"
                            data-url="https://t.me/ethio_schoollibrary"
                            onclick="handleTaskClick('TG_CH', 150, 'https://t.me/ethio_schoollibrary');">
                        ·â∞·âÄ·àã·âÄ·àç!
                    </button>
                </div>

                <div class="info-item" id="task-tg-gp">
                    <span class="item-label">
                        <i class="fab fa-telegram-plane" style="color: #00a4e4; margin-right: 5px;"></i> 
                        **·â¥·àå·åç·à´·àù ·åç·à©·çï ·â∞·âÄ·àã·âÄ·àç**
                    </span>
                    <span class="item-value">+100 ·äê·å•·â•</span>
                    <button class="green-button task-button" 
                            data-task-id="TG_GP" 
                            data-points="100"
                            data-url="https://t.me/school_library2012"
                            onclick="handleTaskClick('TG_GP', 100, 'https://t.me/school_library2012');">
                        ·â∞·âÄ·àã·âÄ·àç!
                    </button>
                </div>

                <div class="info-item" id="task-yt-sub" style="border-bottom: none;">
                    <span class="item-label">
                        <i class="fab fa-youtube" style="color: #ff0000; margin-right: 5px;"></i> 
                        **·ã©·â≤·ã©·â• ·à∞·â•·àµ·ä≠·à´·ã≠·â•**
                    </span>
                    <span class="item-value">+300 ·äê·å•·â•</span>
                    <button class="green-button task-button" 
                            data-task-id="YT_SUB" 
                            data-points="300"
                            data-url="YOUR_YOUTUBE_CHANNEL_LINK_HERE"
                            onclick="handleTaskClick('YT_SUB', 300, 'YOUR_YOUTUBE_CHANNEL_LINK_HERE');">
                        ·à∞·â•·àµ·ä≠·à´·ã≠·â•
                    </button>
                </div>
             </ul>
        </div>
        
        <div id="quiz-section" class="reward-section info-card">
            <div class="reward-item" onclick="toggleQuizGame();" style="cursor: pointer;">
                <div id="quiz-icon" class="reward-icon" style="width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: white; font-weight: bold;">100<br>X</div>
                <div class="reward-info">
                    <h4 style="margin: 0 0 2px 0; color: var(--tg-theme-text-color);">·ã®·å≠·äï·âÖ·àã·âµ ·å•·ã´·âÑ·ãé·âΩ</h4>
                    <p style="margin: 0; font-size: 0.9em; color: var(--tg-theme-hint-color);">·ä•·ãç·âÄ·âµ·ãé·äï ·â†·àò·çà·â∞·äï ·äê·å•·â• ·ã´·åç·äô</p>
                </div>
                <button class="action-button">·â∞·å´·ãà·âµ</button>
            </div>
             
             <div id="quiz-game-area" class="info-card hidden-section" style="margin: 15px 0 0 0; padding: 15px; box-shadow: none;">
                 <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 0; color: #6f42c1;">
                     <i class="fas fa-question-circle"></i> ·ãì·àà·àù ·ä†·âÄ·çç ·å•·ã´·âÑ·ãé·âΩ
                 </h3>
                 <p>·âÄ·à™ ·àô·ä®·à´·ãé·âΩ: <span id="quiz-attempts-left">...</span>/5</p>
                 <button class="green-button" onclick="showToast('·â†·âÖ·à≠·â• ·âÄ·äï ·ã≠·å†·â•·âÅ ...');" style="width: 100%; margin-top: 10px;">·å•·ã´·âÑ·ãç·äï ·åÄ·àù·à≠!</button>
                 <p id="quiz-timer-display" style="color: #dc3545; font-weight: bold; margin-top: 15px; display: none;">
                    ·ãµ·åã·àö ·àà·àò·å´·ãà·âµ: <span id="quiz-countdown">...</span>
                 </p>
             </div>
        </div>

    </div>
    
    <div id="top-page" class="hidden-page">
        <h2 style="text-align: center; color: var(--tg-theme-link-color);">üèÜ ·ã®·àã·âÄ ·ã∞·à®·åÉ</h2>
        
        <div class="info-card">
            <h3 style="color: #FFC107;"><i class="fas fa-medal"></i> ·ã®·à≥·àù·äï·â± ·àù·à≠·å• ·äê·å•·â• ·ä†·à∞·â£·à≥·â¢·ãé·âΩ</h3>
            
            <div id="leaderboard-points">
                <div class="info-item">
                    <span class="item-label" style="font-weight: bold; color: #FFC107;">ü•á 1. Abel (·ä†·äï·â∞)</span>
                    <span class="item-value">3,500 ·äê·å•·â•</span>
                </div>
                <div class="info-item">
                    <span class="item-label">ü•à 2. Bethlehem</span>
                    <span class="item-value">3,200 ·äê·å•·â•</span>
                </div>
                 <div class="info-item">
                    <span class="item-label">ü•â 3. Kaleb.T</span>
                    <span class="item-value">2,950 ·äê·å•·â•</span>
                </div>
            </div>
            
        </div>
        
        <div class="info-card">
            <h3 style="color: #4CAF50;"><i class="fas fa-shopping-cart"></i> Top ·åà·ã¢·ãé·âΩ (·â†·ãà·à≠)</h3>
            <div id="leaderboard-purchases">
                 <div class="info-item">
                    <span class="item-label">1. Selam.A</span>
                    <span class="item-value">12,500 ·â•·à≠</span>
                </div>
                 <div class="info-item">
                    <span class="item-label">2. Yonas.M</span>
                    <span class="item-value">8,100 ·â•·à≠</span>
                </div>
            </div>
        </div>
        
        <div class="info-card" style="text-align: center;">
            <p>·ã®·ä•·à≠·àµ·ãé ·ã∞·à®·åÉ: **175·äõ**</p>
            <p style="font-size: 0.9em; color: var(--tg-theme-hint-color);">·àà·àò·ãà·ã≥·ã∞·à≠ ·åå·àû·âΩ·äï ·ã≠·å´·ãà·â± ·ãà·ã≠·àù ·àò·åΩ·àê·çç ·ã≠·åç·ãô!</p>
        </div>
    </div>
    
    <div id="bottom-nav">
        <div class="nav-item" onclick="switchPage('tasks');">
            <div class="nav-icon"><i class="fas fa-bolt"></i></div>
            Tasks
        </div>
        <div id="shop-nav" class="nav-item active" onclick="switchPage('shop');">
            <div class="nav-icon"><i class="fas fa-shopping-bag"></i></div>
            Shop
        </div>
        <div class="nav-item" onclick="switchPage('top');">
            <div class="nav-icon"><i class="fas fa-crown"></i></div>
            Top
        </div>
        <div id="profile-nav" class="nav-item" onclick="switchPage('profile');">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            Profile
        </div>
    </div>
    

    <script>
        // ********** GLOBAL VARIABLES AND TELEGRAM SETUP **********
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        // üí° ·ã®Netlify Function URL
        const NETLIFY_FUNCTION_URL = 'https://schoollibrary1.netlify.app/.netlify/functions/tbot_handler';
        const DAILY_RESET_MS = 24 * 60 * 60 * 1000;
        const MAX_SPIN_ATTEMPTS = 5; 
        const MAX_QUIZ_ATTEMPTS = 5; 
        
        let cart = [];
        let totalPrice = 0;
        
        // Backend State Variables
        let currentPoints = 0; 
        let spinAttempts = 0; 
        let spinResetTime = 0;
        let socialTasksStatus = {}; 
        let dailyClaimTime = 0;
        let quizAttempts = 0; 
        let quizResetTime = 0;
        let lastOperationTime = 0; // ·àà·ãã·äì·ãç ·ã®·à∞·ãì·âµ ·âÜ·å£·à™ ·àò·äê·àª
        
        let spinTimerInterval = null;
        let quizTimerInterval = null;
        let taskTimerInterval = null;
        
        // Spin Wheel Data (·ä® Backend ·åã·à≠ ·ã®·â∞·å£·å£·àò)
        const prizes = [
            { text: "50 ·äê·å•·â•", color: "#FFC107", value: 50 },
            { text: "100 ·äê·å•·â•", color: "#4CAF50", value: 100 },
            { text: "150 ·äê·å•·â•", color: "#2196F3", value: 150 },
            { text: "200 ·äê·å•·â•", color: "#E91E63", value: 200 },
            { text: "250 ·äê·å•·â•", color: "#9C27B0", value: 250 },
            { text: "500 ·äê·å•·â•", color: "#FF5722", value: 500 },
            { text: "·â£·ã∂", color: "#F44336", value: 0 }, 
        ];

        // Book Catalog Data
        const bookData = [
            {
                category: "·à≥·ã≠·äï·àµ",
                items: [
                    { id: "S001", name: "·ã®·à•·äê-·àï·ã≠·ãà·âµ ·àò·à†·à®·â∂·âΩ", price: 150.00, pdf_id: "PDF_SC01", photo_url: "https://via.placeholder.com/80x100?text=S001" },
                    { id: "S002", name: "·ã®·çä·ãö·ä≠·àµ ·âµ·àù·àÖ·à≠·âµ", price: 175.50, pdf_id: "PDF_SC02", photo_url: "https://via.placeholder.com/80x100?text=S002" },
                ]
            },
            {
                category: "·à•·äê ·åΩ·àë·çç",
                items: [
                    { id: "L001", name: "·ã®·àÄ·åà·à≠ ·çç·âÖ·à≠ ·åç·å•·àû·âΩ", price: 120.00, pdf_id: "PDF_LIT1", photo_url: "https://via.placeholder.com/80x100?text=L001" },
                    { id: "L002", name: "·ä†·å´·å≠·à≠ ·â≥·à™·äÆ·âΩ", price: 110.00, pdf_id: "PDF_LIT2", photo_url: "https://via.placeholder.com/80x100?text=L002" },
                ]
            },
        ];
        
        // ********** UTILITY FUNCTIONS (TOAST, FETCH) **********
        
        function showToast(message, duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => { toast.classList.add('show'); }, 10); 
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 500); 
            }, duration);
        }

        function sendBackendRequest(data) {
            return fetch(NETLIFY_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...data,
                    user_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "UNKNOWN_USER"
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .catch(error => {
                console.error('Frontend Fetch Error:', error);
                showToast(`‚ùå Backend ·àã·ã≠ ·âΩ·åç·à≠ ·â∞·çà·å†·à®!`);
                return { action: "error", message: error.message };
            });
        }
        
        // ********** INITIAL DATA LOAD & PROCESSOR **********
        function loadInitialData() {
            sendBackendRequest({ action: "request_initial_data" })
            .then(data => {
                if (data.action !== "error") {
                    processBotResponse(data);
                }
            });
            updatePointsDisplay(currentPoints);
        }
        
        function processBotResponse(data) {
            
            if (data.action === "initial_data") {
                updatePointsDisplay(data.points || 0);
                
                spinAttempts = data.spin_data.attempts || 0; 
                spinResetTime = data.spin_data.last_spin || 0;
                
                quizAttempts = data.quiz_data.attempts || 0;
                quizResetTime = data.quiz_data.last_quiz || 0;
                
                dailyClaimTime = data.daily_bonus.last_claim || 0; 
                socialTasksStatus = data.tasks_status || {};
                
                lastOperationTime = data.last_operation_time || (Date.now() - (DAILY_RESET_MS / 4));
                
                initializeProfile();
                if (document.getElementById('tasks-page').classList.contains('hidden-page') === false) {
                     initializeTasksPage(); 
                }
            }
            
            else if (data.action === "task_verified" && data.task_id) {
                const pointsGained = data.points_gained || 0;
                socialTasksStatus[data.task_id] = { completed: data.success, status: data.success ? 'DONE' : 'FAILED' };
                updateTaskDisplay(socialTasksStatus); 

                if (data.success) {
                    updatePointsDisplay(data.new_points); 
                    showToast(`‚úÖ Task ·â∞·å†·äì·âã·àç! +${pointsGained} ·äê·å•·â• ·åà·â•·â∂·àç·ãé·â≥·àç!`);
                } else {
                    tg.showAlert("‚ö†Ô∏è ·àõ·à®·åã·åà·å´·ãç ·ä†·àç·â∞·à≥·ä´·àù·ç¢ ·âª·äì·àâ·äï/·åç·à©·çë·äï ·â†·âµ·ä≠·ä≠·àç ·â∞·âÄ·àã·âÖ·àà·ãã·àç?!");
                }
            } 
            
            else if (data.action === "spin_result") {
                const wonPrizeValue = data.points_won;
                const winningIndex = prizes.findIndex(p => p.value === wonPrizeValue);
                const prizeText = prizes[winningIndex] ? prizes[winningIndex].text : `${wonPrizeValue} ·äê·å•·â•`;

                stopSpinWheel(winningIndex); 
                 
                setTimeout(() => {
                    updatePointsDisplay(data.new_points); 
                    spinAttempts = data.attempts_left; 
                    spinResetTime = data.last_spin; 
                    
                    if (wonPrizeValue > 0) {
                        showToast(`üéâ ${prizeText} ·ä†·à∏·äï·çà·ãã·àç!`);
                    } else {
                        showToast(`üòî ${prizeText} ·ä†·åã·å•·àû·àÉ·àç·ç¢ ·àà·àö·âÄ·å•·àà·ãç ·åä·ãú ·àû·ä≠·à≠!`);
                    }
                    
                    updateSpinDisplay(); 
                    initializeTasksPage(); 
                 }, 5500); 
            }
            
            else if (data.action === "daily_bonus_claimed") {
                const couponButton = document.getElementById('coupon-btn');
                if (data.success) {
                    updatePointsDisplay(data.new_points);
                    dailyClaimTime = data.last_claim; 
                    
                    showToast(`üéâ ·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·àÖ! ·ã®·ãï·àà·â± ${DAILY_BONUS_POINTS} ·äê·å•·â• ·åà·â•·â∂·àç·ãé·â≥·àç!`);
                    
                    couponButton.disabled = true;
                    couponButton.textContent = "‚úî ·ãï·àà·â≥·ãä";
                    couponButton.style.backgroundColor = '#6c757d';
                } else {
                    showToast("‚ùå ·ã®·ãï·àà·â≥·ãä ·àΩ·àç·àõ·âµ ·å•·ã´·âÑ·ãé ·ä†·àç·â∞·à≥·ä´·àù·ç¢");
                    couponButton.disabled = false;
                    couponButton.textContent = "Coupon";
                    couponButton.style.backgroundColor = '#6f42c1'; 
                }
                initializeTasksPage(); 
            }
            
            else if (data.action === "payment_initiated") {
                 showToast("·ã®·ä≠·çç·ã´ ·å•·ã´·âÑ ·àç·ä¨·ã´·àà·àÅ·ç¢ ·â†·â¶·â± ·àò·àç·ãï·ä≠·âµ ·ã≠·å†·â•·âÅ·ç¢");
                 cart = [];
                 totalPrice = 0;
                 updateCartDisplay();
            }
            
            // ·ã®·â¶·âµ ·àò·àç·ãï·ä≠·âµ ·à≤·ã∞·à≠·àµ ·ã®·àö·ã∞·à®·åâ ·àõ·à®·åã·åà·å´·ãé·âΩ (·ä†·àõ·à´·å≠)
            tg.onEvent('web_app_data', (event) => {
                try {
                    const botData = JSON.parse(event.data);
                    if (botData.action === 'payment_confirmed') {
                        // üí° ·àò·åΩ·àê·çç·â±·äï ·ã≠·àà·âÄ·âÉ·àç/·ã®·â∞·à≥·ä´ ·àò·àç·ä•·ä≠·âµ ·ã≠·àç·ä´·àç
                        tg.showAlert("‚úÖ ·ä≠·çç·ã´ ·â∞·à≥·ä≠·â∑·àç·ç¢ ·àò·åΩ·àê·çç·âµ·ãé ·â∞·àà·âÄ·ãã·àç!");
                    }
                } catch (e) {
                    console.error("Error processing web_app_data:", e);
                }
            });
        }
        
        // ********** PAGE AND PROFILE LOGIC **********
        function initializeProfile() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                const username = user.username || (user.first_name + " " + (user.last_name || "")).trim();
                document.getElementById('display-username').textContent = username;
                document.getElementById('profile-initial').textContent = username.charAt(0).toUpperCase();
            }
            updatePointsDisplay(currentPoints);
        }

        function switchPage(pageName) {
            const pages = ['shop-page', 'profile-page', 'tasks-page', 'top-page'];
            const navItems = document.querySelectorAll('#bottom-nav .nav-item');
            
            pages.forEach(id => {
                const pageElement = document.getElementById(id);
                if (pageElement) {
                    pageElement.classList.add('hidden-page');
                }
            });
            
            const selectedPageId = `${pageName}-page`;
            const selectedPageElement = document.getElementById(selectedPageId);
            if (selectedPageElement) {
                selectedPageElement.classList.remove('hidden-page');
            }

            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.onclick.toString().includes(`'${pageName}'`)) {
                    item.classList.add('active');
                }
            });

            if (pageName === 'shop') {
                updateCartDisplay();
            } else {
                tg.MainButton.hide();
            }
            
            if (pageName === 'tasks') {
                 // ·ã® Spin/Quiz ·ä≠·çç·àé·âΩ·äï ·ã∞·â•·âÖ
                 document.getElementById('spin-game-area').style.display = 'none';
                 document.getElementById('quiz-game-area').classList.add('hidden-section');
                 document.getElementById('social-tasks-list').classList.add('hidden-section');
                 initializeTasksPage(); 
            } else {
                clearInterval(taskTimerInterval);
            }
        }
        
        // ********** SHOP AND CART LOGIC **********
        function renderCatalog() {
            const catalogDiv = document.getElementById('catalog');
            catalogDiv.innerHTML = ''; 
            
            bookData.forEach(categoryData => {
                const h2 = document.createElement('h2');
                h2.textContent = categoryData.category;
                catalogDiv.appendChild(h2);
                
                const ul = document.createElement('ul');
                ul.className = 'book-list';
                ul.style.listStyle = 'none';
                ul.style.padding = '0';
                
                categoryData.items.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'info-item'; 
                    
                    const img = document.createElement('img');
                    img.src = book.photo_url; 
                    img.alt = book.name;
                    img.style.width = '60px'; img.style.height = '80px'; img.style.marginRight = '10px';
                    li.appendChild(img);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.style.flexGrow = '1';
                    
                    const nameP = document.createElement('p');
                    nameP.textContent = book.name;
                    nameP.style.fontWeight = 'bold';
                    nameP.style.margin = '0 0 5px 0';
                    infoDiv.appendChild(nameP);
                    
                    const priceP = document.createElement('p');
                    priceP.textContent = `${book.price.toFixed(2)} ·â•·à≠`;
                    priceP.style.color = 'var(--tg-theme-link-color)';
                    priceP.style.margin = '0';
                    infoDiv.appendChild(priceP);
                    
                    li.appendChild(infoDiv);
                    
                    const addButton = document.createElement('button');
                    addButton.className = 'green-button';
                    addButton.textContent = `+ ·å®·àù·à≠`; 
                    addButton.onclick = () => addToCart(book.id, book.name, book.price);
                    li.appendChild(addButton);
                    
                    ul.appendChild(li);
                });
                
                catalogDiv.appendChild(ul);
            });
        }

        function addToCart(itemId, itemName, itemPrice) {
            const item = cart.find(i => i.id === itemId);
            if (item) {
                item.quantity += 1; 
            } else {
                cart.push({ id: itemId, name: itemName, price: itemPrice, quantity: 1 });
            }
            totalPrice += itemPrice;
            updateCartDisplay();
            showToast(`‚úÖ ${itemName} ·ãà·ã∞ ·åã·à™ ·â∞·å®·àù·àØ·àç!`);
        }
        
        function decreaseQuantity(itemId) {
            const itemIndex = cart.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                totalPrice = Math.max(0, totalPrice - item.price);
                item.quantity -= 1; 
                if (item.quantity <= 0) {
                    cart.splice(itemIndex, 1); 
                }
                updateCartDisplay(); 
            }
        }
        
        function updateCartDisplay() {
            const cartList = document.getElementById('cart-items');
            cartList.innerHTML = ''; 
            
            cart.forEach(item => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '5px 0';

                const itemText = document.createElement('span');
                itemText.textContent = `${item.name} (${item.quantity}) - ${ (item.price * item.quantity).toFixed(2) } ·â•·à≠`;
                li.appendChild(itemText);
                
                const removeButton = document.createElement('button');
                removeButton.textContent = '·à∞·à≠·ãù';
                removeButton.style.backgroundColor = '#dc3545';
                removeButton.style.color = 'white';
                removeButton.style.padding = '5px 10px';
                removeButton.style.borderRadius = '8px';
                removeButton.style.marginLeft = '10px';
                removeButton.onclick = () => decreaseQuantity(item.id);
                li.appendChild(removeButton);
                
                cartList.appendChild(li);
            });
            
            document.getElementById('total-price').textContent = totalPrice.toFixed(2);
            
            if (totalPrice > 0 && !document.getElementById('shop-page').classList.contains('hidden-page')) {
                tg.MainButton.setText(`·ä≠·çç·ã´ ·ã≠·çà·åΩ·àô: ${totalPrice.toFixed(2)} ·â•·à≠`).show();
                tg.MainButton.enable(); 
            } else {
                tg.MainButton.hide();
            }
        }
        
        // Main Button Payment Handler
        tg.MainButton.onClick(() => {
            if (cart.length === 0) return;
            
            tg.MainButton.setText("·ä≠·çç·ã´ ·â†·àõ·àò·äï·å®·âµ ·àã·ã≠...").disable();
            
            const paymentDetails = {
                action: "initiate_telebirr_payment", 
                total: totalPrice.toFixed(2),
                cart_items: cart.map(item => ({ 
                    id: item.id, 
                    qty: item.quantity, 
                    pdf_id: bookData.flatMap(c => c.items).find(i => i.id === item.id)?.pdf_id || "PDF_MISSING"
                }))
            };
            
            sendBackendRequest(paymentDetails)
            .then(data => {
                tg.MainButton.setText(`·ä≠·çç·ã´ ·ã≠·çà·åΩ·àô: ${totalPrice.toFixed(2)} ·â•·à≠`).enable(); 
                if (data.action === "error") {
                     showToast("·ä≠·çç·ã´ ·àà·àò·åÄ·àò·à≠ ·ä†·àç·â∞·âª·àà·àù·ç¢");
                }
            })
            .catch(() => {
                tg.MainButton.setText(`·ä≠·çç·ã´ ·ã≠·çà·åΩ·àô: ${totalPrice.toFixed(2)} ·â•·à≠`).enable();
            });
        });
        
        // ********** TASKS AND TIMER LOGIC **********
        
        function updateTimerDisplay(lastOpTime) {
            const timerElements = {
                hours: document.getElementById('timer-hours'),
                minutes: document.getElementById('timer-minutes'),
                seconds: document.getElementById('timer-seconds')
            };
            
            const now = Date.now();
            const timeElapsed = now - lastOpTime;
            let remaining = DAILY_RESET_MS - (timeElapsed % DAILY_RESET_MS);
            
            if (remaining <= 0 || timeElapsed >= DAILY_RESET_MS) {
                 // ·à™·à¥·âµ ·ã®·àö·ã´·àµ·çà·àç·åç ·ä®·àÜ·äê ·ä•·äï·ã∞·åà·äì ·ã≥·â≥ ·ä•·äï·å†·ã≠·âÉ·àà·äï
                 if (taskTimerInterval) {
                     clearInterval(taskTimerInterval);
                     taskTimerInterval = null; 
                     loadInitialData(); // ·ã≥·â≥ ·ä•·äï·ã∞·åà·äì ·â†·àò·å†·ã®·âÖ ·à™·à¥·âµ ·ä•·äï·ã≤·ã∞·à®·åç ·ä•·äì·ã∞·à≠·åã·àà·äï
                     remaining = DAILY_RESET_MS; 
                 }
            }
            
            const totalSeconds = Math.floor(remaining / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            timerElements.hours.textContent = String(hours).padStart(2, '0');
            timerElements.minutes.textContent = String(minutes).padStart(2, '0');
            timerElements.seconds.textContent = String(seconds).padStart(2, '0');
        }
        
        function initializeTasksPage() {
             updateTaskDisplay(socialTasksStatus);
             updateSpinDisplay();
             updateQuizDisplay();

             const initialResetTime = lastOperationTime; 
             
             clearInterval(taskTimerInterval);
             taskTimerInterval = setInterval(() => {
                 updateTimerDisplay(initialResetTime); 
             }, 1000);
        }
        
        // ********** DAILY BONUS LOGIC **********
        function handleDailyClaim() {
            const now = Date.now();
            const timeElapsed = now - dailyClaimTime;
            const couponButton = document.getElementById('coupon-btn');
            
            if (timeElapsed < DAILY_RESET_MS && dailyClaimTime > 0) {
                 const remainingSeconds = Math.floor((DAILY_RESET_MS - timeElapsed) / 1000);
                 const h = Math.floor(remainingSeconds / 3600);
                 const m = Math.floor((remainingSeconds % 3600) / 60);
                 showToast(`‚ö†Ô∏è ·ä†·àµ·âÄ·ãµ·àò·ãç ·ãà·àµ·ã∞·ãã·àç·ç¢ ${h} ·à∞·ãì·âµ ·ä® ${m} ·ã∞·âÇ·âÉ ·ã≠·å†·â•·âÅ·ç¢`);
                 return;
            }
            
            couponButton.disabled = true;
            couponButton.textContent = "·â†·àõ·àµ·çà·çÄ·àù ·àã·ã≠...";
            couponButton.style.backgroundColor = '#ffc107'; 
            
            sendBackendRequest({ action: "claim_daily_bonus" })
            .then(processBotResponse)
            .catch(() => {
                couponButton.disabled = false;
                couponButton.textContent = "Coupon";
                couponButton.style.backgroundColor = '#6f42c1'; 
            });
        }


        // ********** SPIN WHEEL LOGIC **********
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spin-button');
        const attemptsLeftSpan = document.getElementById('attempts-left');
        const countdownSpan = document.getElementById('countdown');
        const timerDisplay = document.getElementById('timer-display');
        
        function updateSpinDisplay() {
            attemptsLeftSpan.textContent = `${spinAttempts}/${MAX_SPIN_ATTEMPTS}`;
            
            if (spinAttempts > 0) {
                spinButton.disabled = false;
                spinButton.textContent = "·ä•·àΩ·ä≠·à≠·ä≠·à©!";
                timerDisplay.style.display = 'none';
                clearInterval(spinTimerInterval); 
            } else {
                spinButton.disabled = true;
                spinButton.textContent = "·ã≠·å†·â•·âÅ...";
                timerDisplay.style.display = 'block'; 
                
                if (spinResetTime > 0) { 
                     startCountdown('spin', spinResetTime);
                } else {
                     clearInterval(spinTimerInterval); 
                     countdownSpan.textContent = "00:00:00"; 
                }
            }
        }
        
        function drawWheel() {
            const totalPrizes = prizes.length;
            const arcSize = (2 * Math.PI) / totalPrizes;
            const radius = canvas.width / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            prizes.forEach((prize, i) => {
                const angle = i * arcSize;
                ctx.beginPath();
                ctx.arc(radius, radius, radius, angle, angle + arcSize);
                ctx.lineTo(radius, radius);
                ctx.fillStyle = prize.color;
                ctx.fill();
                
                ctx.save();
                ctx.fillStyle = "white";
                ctx.font = "bold 12px Arial";
                ctx.translate(radius, radius);
                ctx.rotate(angle + arcSize / 2);
                ctx.textAlign = "right";
                ctx.fillText(prize.text, radius * 0.8, 5);
                ctx.restore();
            });
        }
        
        function playSpinSound() {
            const spinSound = document.getElementById('spin-sound');
            if (spinSound) {
                spinSound.currentTime = 0; 
                spinSound.play().catch(e => console.log("Sound playback failed:", e));
            }
        }
        
        function stopSpinWheel(winningIndex) {
             const totalRotations = 5; 
             const prizeArc = 360 / prizes.length;
             const targetAngle = 360 - (winningIndex * prizeArc) - (prizeArc / 2); 
             const rotationDegree = 360 * totalRotations + targetAngle;
             
             canvas.style.transform = `rotate(${rotationDegree}deg)`;
             
             document.getElementById('spin-sound').pause();
        }

        function spinWheel() {
             if (spinAttempts <= 0 || spinButton.disabled) {
                showToast("‚ö†Ô∏è ·âÄ·à™ ·àô·ä®·à´ ·ã®·àà·ãé·âµ·àù·ç¢ ·ä•·â£·ä≠·ãé ·ã≠·å†·â•·âÅ·ç¢");
                return;
            }
            
            playSpinSound();
            
            spinButton.disabled = true;
            spinButton.textContent = "·â†·àõ·àΩ·ä®·à≠·ä®·à≠ ·àã·ã≠...";
            
            canvas.style.transition = 'none'; 
            canvas.style.transform = 'rotate(0deg)';
            setTimeout(() => {
                canvas.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
            }, 10);
            
            const spinData = {
                action: "spin_attempt"
            };
            
            sendBackendRequest(spinData)
            .then(processBotResponse)
            .catch(() => {
                 spinButton.disabled = false;
                 spinButton.textContent = "·ä•·àΩ·ä≠·à≠·ä≠·à©!";
            });
        }
        
        function toggleSpinGame() {
            const spinArea = document.getElementById('spin-game-area');
            const isHidden = spinArea.style.display === 'none' || spinArea.style.display === '';
            spinArea.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                initializeSpinWheel();
            }
        }
        
        function initializeSpinWheel() {
            drawWheel();
            updateSpinDisplay();
            spinButton.onclick = spinWheel;
        }

        // ********** QUIZ LOGIC **********
        const quizAttemptsLeftSpan = document.getElementById('quiz-attempts-left');
        const quizCountdownSpan = document.getElementById('quiz-countdown');
        const quizTimerDisplay = document.getElementById('quiz-timer-display');
        
        function updateQuizDisplay() {
            quizAttemptsLeftSpan.textContent = `${quizAttempts}/${MAX_QUIZ_ATTEMPTS}`;
            
            if (quizAttempts <= 0) {
                quizTimerDisplay.style.display = 'block';
                if (quizResetTime > 0) {
                    startCountdown('quiz', quizResetTime);
                } else {
                    clearInterval(quizTimerInterval);
                    quizCountdownSpan.textContent = "00:00:00";
                }
            } else {
                quizTimerDisplay.style.display = 'none';
                clearInterval(quizTimerInterval);
            }
        }
        
        function toggleQuizGame() {
             const quizArea = document.getElementById('quiz-game-area');
             quizArea.classList.toggle('hidden-section');
             if (!quizArea.classList.contains('hidden-section')) {
                 updateQuizDisplay();
             }
        }
        
        // ********** GENERAL COUNTDOWN LOGIC **********
        function startCountdown(type, resetTime) {
             const countdownSpanEl = type === 'spin' ? countdownSpan : quizCountdownSpan;
             const timerDisplayEl = type === 'spin' ? timerDisplay : quizTimerDisplay;
             const intervalVar = type === 'spin' ? 'spinTimerInterval' : 'quizTimerInterval';
             
             clearInterval(window[intervalVar]); 

             timerDisplayEl.style.display = 'block';

             function updateTimer() {
                const now = Date.now();
                const timeRemaining = resetTime - now; 

                if (timeRemaining <= 0) {
                    clearInterval(window[intervalVar]);
                    loadInitialData(); // ·à™·à¥·âµ ·ä•·äï·ã≤·ã∞·à®·åç Backend·äï ·ã≠·å†·ã≠·âÉ·àç
                    return;
                }

                const totalSeconds = Math.floor(timeRemaining / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                countdownSpanEl.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            window[intervalVar] = setInterval(updateTimer, 1000);
            updateTimer(); 
        }

        // ********** SOCIAL TASKS LOGIC **********
        function toggleTaskList(listId) {
             const list = document.getElementById(listId);
             list.classList.toggle('hidden-section');
             if (listId === 'social-tasks-list') {
                 updateTaskDisplay(socialTasksStatus);
             }
        }
        
        function updateTaskDisplay(tasksStatus) {
            socialTasksStatus = tasksStatus; 
            for (const taskId in tasksStatus) {
                const taskElementId = `task-${taskId.toLowerCase().replace('_', '-')}`;
                const item = document.getElementById(taskElementId);
                const button = item ? item.querySelector('.task-button') : null;
                const originalText = button ? (taskId === 'YT_SUB' ? '·à∞·â•·àµ·ä≠·à´·ã≠·â•' : '·â∞·âÄ·àã·âÄ·àç!') : '';

                if (!button) continue; 
                
                if (tasksStatus[taskId].completed) {
                    button.textContent = "·â∞·å†·äì·âã·àç ‚úîÔ∏è";
                    button.disabled = true;
                    button.style.backgroundColor = '#6c757d'; 
                } else if (tasksStatus[taskId].status === 'PENDING') {
                    button.disabled = true;
                    button.textContent = "·â†·àõ·à®·åã·åà·å• ·àã·ã≠...";
                    button.style.backgroundColor = '#ffc107'; 
                } else { // NEW or FAILED
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = '#28a745';
                }
            }
        }
        
        function handleTaskClick(taskId, points, url) {
            if (socialTasksStatus[taskId] && socialTasksStatus[taskId].completed) {
                showToast("·ã≠·àÖ·äï ·â∞·åç·â£·à≠ ·ä†·àµ·âÄ·ãµ·àò·ãç ·ä†·å†·äì·âÄ·ãã·àç!");
                return;
            }

            // 1. ·âª·äì·àâ·äï/·ã©·â≤·ã©·â•·äï ·ä•·äï·ã≤·ä®·çç·âµ ·ã´·ã∞·à≠·åã·àç
            tg.openLink(url);
            
            // 2. ·àõ·à®·åã·åà·å´ ·àò·å†·ã®·âÖ
            tg.showConfirm(
                "·âª·äì·àâ·äï/·à∞·â•·àµ·ä≠·à´·ã≠·â• ·ä´·ã∞·à®·åâ ·â†·äã·àã '·ä•·à≠·åç·å†·äõ ·äê·äù' ·ã®·àö·àà·ãç·äï ·ã≠·å´·äë·ç¢", 
                (isConfirmed) => {
                    if (isConfirmed) {
                        const button = document.querySelector(`[data-task-id="${taskId}"]`);
                        
                        const verificationData = {
                            action: "verify_social_task",
                            task_id: taskId,
                            points: points // ·äê·å•·â°·äï ·ãà·ã∞ Backend ·àò·àã·ä≠
                        };
                        
                         sendBackendRequest(verificationData)
                        .then(processBotResponse)
                        .catch(() => {
                            // ·àµ·àÖ·â∞·âµ ·â¢·çà·å†·à≠ ·ä†·ãù·à´·à©·äï ·ãà·ã∞·äê·â†·à®·â†·âµ ·ã≠·àò·àç·à≥·àç
                            button.disabled = false;
                            button.textContent = button.dataset.taskText || (taskId === 'YT_SUB' ? '·à∞·â•·àµ·ä≠·à´·ã≠·â•' : '·â∞·âÄ·àã·âÄ·àç!');
                            button.style.backgroundColor = '#28a745';
                        });
                        
                        showToast("·å•·ã´·âÑ·ãé ·â∞·àç·ä≥·àç·ç¢ ·âµ·ä≠·ä≠·àà·äõ·äê·âµ·ãé·äï ·ä•·àµ·ä™·ã´·à®·åã·åç·å• ·ã≠·å†·â•·âÅ!");

                        if (button) {
                            button.disabled = true;
                            button.textContent = "·â†·àõ·à®·åã·åà·å• ·àã·ã≠...";
                            button.style.backgroundColor = '#ffc107'; 
                        }

                    } else {
                        showToast("·ä•·à≠·åç·å†·äõ ·äê·äù ·à≥·ã≠·å´·äë ·ä®·ãà·å° ·àõ·à®·åã·åà·å´·ãç ·ä†·ã≠·à∞·à´·àù!");
                    }
                }
            );
        }
        
        // ********** GENERAL STATE UPDATES **********
        function updatePointsDisplay(newPoints) {
            currentPoints = newPoints;
            document.getElementById('user-points').textContent = currentPoints;
        }

        // ·àò·â∞·åç·â†·à™·ã´·ãç ·à≤·åÄ·àù·à≠ ·ã®·àö·å†·à© ·â∞·åç·â£·à´·âµ
        renderCatalog();
        loadInitialData(); 
        switchPage('shop'); 

    </script>
</body>
</html>
